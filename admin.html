<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üõ†Ô∏è Admin Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body{
    background:radial-gradient(ellipse at top,#1e293b,#020617);
    color:#e5e7eb;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif
  }
  section{
    background:linear-gradient(180deg,#0f172a,#020617);
    border:1px solid rgba(255,255,255,.06);
    box-shadow:0 10px 30px rgba(0,0,0,.45)
  }
  input,select{
    background:#fff!important;
    color:#000!important;
    border:1px solid #cbd5e1
  }
  table td,table th{padding:.4rem}
</style>
</head>

<body class="p-4 space-y-6">

<h1 class="text-2xl font-bold text-center">üõ†Ô∏è Admin Dashboard</h1>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= TOAST ================= */
const Toast = Swal.mixin({
  toast:true,
  position:'top-end',
  showConfirmButton:false,
  timer:1500,
  background:'#1e293b',
  color:'#fff'
});

/* ================= UTIL ================= */
function thaiRange(d){
  const s = new Date(d+'T00:00:00+07:00');
  const e = new Date(d+'T23:59:59+07:00');
  return { start:s.toISOString(), end:e.toISOString() };
}
</script>

<!-- ================= BILLS ================= -->
<section class="p-4 rounded-xl space-y-3">
  <h2 class="font-bold">üßæ ‡∏ö‡∏¥‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>

  <input type="date" id="billDate"
    class="p-2 rounded"
    onchange="loadBills()">

  <div class="font-bold">
    ‡∏£‡∏ß‡∏°: <span id="dailyTotal" class="text-emerald-400">0</span> ‡∏ö‡∏≤‡∏ó
  </div>

  <div class="flex gap-2">
    <button onclick="exportExcel()"
      class="bg-emerald-600 px-3 py-1 rounded">
      üì§ Export Excel
    </button>

    <button onclick="clearAllBills()"
      class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded">
      üßπ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
    </button>
  </div>

  <div id="billList" class="space-y-2 text-sm"></div>
</section>

<script>
/* ================= LOAD BILLS ================= */
async function loadBills(){
  const d=billDate.value; if(!d) return;
  const {start,end}=thaiRange(d);

  const { data:orders } = await db.from('orders')
    .select(`id,total,created_at,order_items!order_items_order_id_fkey(product_name,qty,price)`)
    .gte('created_at',start)
    .lte('created_at',end);

  billList.innerHTML='';
  let sum=0;

  orders.forEach(o=>{
    sum+=o.total;
    billList.innerHTML+=`
      <div class="border p-2 rounded">
        <b>${o.total} ‡∏ö‡∏≤‡∏ó</b>
        ${o.order_items.map(i=>`
          <div>- ${i.product_name} √ó ${i.qty}</div>
        `).join('')}
      </div>`;
  });

  dailyTotal.innerText=sum;
}

/* ================= EXPORT ================= */
async function exportExcel(){
  const d=billDate.value; if(!d) return;
  const {start,end}=thaiRange(d);

  const { data:orders } = await db.from('orders')
    .select(`order_items!order_items_order_id_fkey(product_name,qty,price)`)
    .gte('created_at',start)
    .lte('created_at',end);

  let rows=[['‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡∏£‡∏ß‡∏°']];
  orders.forEach(o=>{
    o.order_items.forEach(i=>{
      rows.push([i.product_name,i.qty,i.qty*i.price]);
    });
  });

  const csv='\ufeff'+rows.map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  a.download=`‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢_${d}.csv`;
  a.click();
}

/* ================= CLEAR ALL BILLS ================= */
async function clearAllBills(){
  const d=billDate.value;
  if(!d) return;

  const ok = await Swal.fire({
    title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
    text:'‡∏à‡∏∞‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
    icon:'warning',
    showCancelButton:true,
    confirmButtonColor:'#dc2626',
    confirmButtonText:'‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'
  });

  if(!ok.isConfirmed) return;

  const {start,end}=thaiRange(d);

  /* 1Ô∏è‚É£ ‡∏î‡∏∂‡∏á order id */
  const { data:orders } = await db
    .from('orders')
    .select('id')
    .gte('created_at',start)
    .lte('created_at',end);

  if(!orders || orders.length===0){
    Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏¥‡∏•','‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å','info');
    return;
  }

  const orderIds = orders.map(o=>o.id);

  /* 2Ô∏è‚É£ ‡∏•‡∏ö order_items */
  const { error:e1 } = await db
    .from('order_items')
    .delete()
    .in('order_id',orderIds);

  if(e1){
    Swal.fire('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ',e1.message,'error');
    return;
  }

  /* 3Ô∏è‚É£ ‡∏•‡∏ö orders */
  const { error:e2 } = await db
    .from('orders')
    .delete()
    .in('id',orderIds);

  if(e2){
    Swal.fire('‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ',e2.message,'error');
    return;
  }

  Toast.fire({icon:'success',title:'‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß'});
  loadBills();
}

/* ================= INIT ================= */
billDate.value=new Date().toISOString().split('T')[0];
loadBills();
</script>

</body>
</html>
