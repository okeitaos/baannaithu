<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>üçú POS ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen p-4">

<!-- ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
<audio id="beepSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<div class="max-w-7xl mx-auto grid grid-cols-12 gap-4">

  <!-- ‡πÇ‡∏ï‡πä‡∏∞ -->
  <div class="col-span-3 bg-slate-800 rounded-xl p-4">
    <h2 class="font-bold mb-3">ü™ë ‡πÇ‡∏ï‡πä‡∏∞</h2>
    <div id="tableList" class="grid grid-cols-2 gap-2"></div>
  </div>

  <!-- ‡πÄ‡∏°‡∏ô‡∏π -->
  <div class="col-span-5 bg-slate-800 rounded-xl p-4">
    <h2 class="font-bold mb-2">üìã ‡πÄ‡∏°‡∏ô‡∏π</h2>

    <div class="flex gap-2 mb-3">
      <button onclick="setCategory('‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô')" class="px-3 py-1 rounded bg-orange-600">üçú ‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</button>
      <button onclick="setCategory('‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°')" class="px-3 py-1 rounded bg-blue-600">ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</button>
      <button onclick="setCategory('‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô')" class="px-3 py-1 rounded bg-green-600">üç¢ ‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</button>
    </div>

    <div id="menuList" class="space-y-3"></div>
  </div>

  <!-- ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ -->
  <div class="col-span-4 bg-slate-800 rounded-xl p-4">
    <h2 class="font-bold mb-3">
      üßæ ‡πÇ‡∏ï‡πä‡∏∞ <span id="currentTable">-</span>
    </h2>

    <div id="cartList" class="space-y-2 mb-4"></div>

    <div class="border-t pt-3 space-y-2">
      <div class="flex justify-between font-bold text-lg">
        <span>‡∏£‡∏ß‡∏°</span>
        <span id="totalPrice">0 ‡∏ø</span>
      </div>

      <button
        onclick="submitOrder()"
        id="sendBtn"
        class="w-full bg-green-600 py-2 rounded disabled:opacity-40"
        disabled>
        üü¢ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå
      </button>
    </div>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co"
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

/* ================= STATE ================= */
let selectedTable = null
let currentCategory = "‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô"
let products = []
let noodleMenus = []
let cart = []

const restrictedMixTargets = ["‡πÅ‡∏Å‡∏á‡∏õ‡∏π", "‡∏ô‡πâ‡∏≥‡∏ä‡∏∏‡∏ö‡∏´‡∏¢‡∏≥"]
const beep = document.getElementById("beepSound")

/* ================= TABLES ================= */
async function loadTables() {
  const { data } = await sb.from("tables").select("*").order("table_no")
  tableList.innerHTML = ""

  data.forEach(t => {
    const btn = document.createElement("button")
    btn.className =
      "p-2 rounded font-bold " +
      (t.status === "occupied" ? "bg-red-600" : "bg-green-600")
    btn.textContent = "‡πÇ‡∏ï‡πä‡∏∞ " + t.table_no
    btn.onclick = () => {
      selectedTable = t
      currentTable.textContent = t.table_no
      renderCart()
    }
    tableList.appendChild(btn)
  })
}

/* ================= MENU ================= */
async function loadMenu() {
  const { data } = await sb.from("products").select("*").eq("active", true)
  products = data || []
  noodleMenus = products.filter(p => p.category === "‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô")

  const list = products.filter(p => p.category === currentCategory)
  menuList.innerHTML = ""

  list.forEach(p => {
    const card = document.createElement("div")
    card.className = "bg-slate-700 p-3 rounded"

    let options = ""
    if (p.category === "‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô") {
      const mixOptions = noodleMenus.filter(n =>
        n.name !== p.name && !restrictedMixTargets.includes(n.name)
      )

      options = `
        <label class="block text-sm">
          <input type="checkbox" class="sp"> ‡∏û‡∏¥‡πÄ‡∏®‡∏© (+10)
        </label>
        <label class="block text-sm mt-1">
          ‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥ (+10)
          <select class="mix text-black ml-1">
            <option value="">-- ‡πÑ‡∏°‡πà‡∏ú‡∏™‡∏° --</option>
            ${mixOptions.map(m => `<option value="${m.id}">${m.name}</option>`).join("")}
          </select>
        </label>
      `
    }

    card.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <div class="font-bold">${p.name}</div>
          <div>${p.price} ‡∏ö‡∏≤‡∏ó</div>
        </div>
        <button class="bg-blue-600 px-4 rounded">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      </div>
      ${options}
    `

    card.querySelector("button").onclick = () => {
      const sp = card.querySelector(".sp")?.checked || false
      const mixId = card.querySelector(".mix")?.value || null

      let price = p.price
      if (sp) price += 10
      if (mixId) price += 10

      addToCart({
        product_id: p.id,
        name: p.name,
        price,
        option_special: sp,
        mix_sauce_id: mixId
      })

      beep.currentTime = 0
      beep.play()

      Swal.fire({
        toast: true,
        position: "top-end",
        icon: "success",
        title: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß",
        showConfirmButton: false,
        timer: 1200
      })
    }

    menuList.appendChild(card)
  })
}

/* ================= CART ================= */
function addToCart(item) {
  const key = `${item.product_id}_${item.option_special}_${item.mix_sauce_id || ""}`
  const found = cart.find(i => i.key === key)

  if (found) found.qty++
  else cart.push({ ...item, qty: 1, key })

  renderCart()
}

function renderCart() {
  cartList.innerHTML = ""
  let total = 0

  cart.forEach((item, index) => {
    total += item.price * item.qty

    const mixName = item.mix_sauce_id
      ? noodleMenus.find(n => n.id === item.mix_sauce_id)?.name
      : ""

    const div = document.createElement("div")
    div.className = "bg-slate-700 p-2 rounded flex justify-between items-center"

    div.innerHTML = `
      <div>
        ${item.name}
        ${item.option_special ? "(‡∏û‡∏¥‡πÄ‡∏®‡∏©)" : ""}
        ${mixName ? `(‡∏ú‡∏™‡∏° ${mixName})` : ""}
        <div class="text-sm text-gray-300">${item.price} ‡∏ö‡∏≤‡∏ó / ‡∏ó‡∏µ‡πà</div>
      </div>
      <div class="flex items-center gap-2">
        <button class="btn-minus px-2 bg-slate-600">-</button>
        <span>${item.qty}</span>
        <button class="btn-plus px-2 bg-slate-600">+</button>
      </div>
    `

    div.querySelector(".btn-minus").onclick = () => {
      item.qty--
      if (item.qty <= 0) cart.splice(index, 1)
      renderCart()
    }

    div.querySelector(".btn-plus").onclick = () => {
      item.qty++
      renderCart()
    }

    cartList.appendChild(div)
  })

  totalPrice.textContent = total + " ‡∏ø"
  sendBtn.disabled = cart.length === 0 || !selectedTable
}

/* ================= SEND ORDER ================= */
async function submitOrder() {
  if (!selectedTable || cart.length === 0) {
    Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "", "warning")
    return
  }

  const confirm = await Swal.fire({
    title: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå ‡πÇ‡∏ï‡πä‡∏∞ ${selectedTable.table_no}`,
    text: `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${cart.reduce((s,i)=>s+i.qty,0)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
  })

  if (!confirm.isConfirmed) return

  Swal.fire({
    title: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  })

  const { data: order } = await sb
    .from("orders")
    .insert({ table_id: selectedTable.id })
    .select()
    .single()

  for (const item of cart) {
    await sb.from("order_items").insert({
      order_id: order.id,
      product_id: item.product_id,
      price: item.price,
      qty: item.qty,
      option_special: item.option_special,
      option_mix: !!item.mix_sauce_id,
      mix_sauce_id: item.mix_sauce_id,
      status: "pending"
    })
  }

  await sb.from("tables")
    .update({ status: "occupied", current_order_id: order.id })
    .eq("id", selectedTable.id)

  cart = []
  renderCart()
  loadTables()

  Swal.fire({
    icon: "success",
    title: "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
    timer: 1500,
    showConfirmButton: false
  })
}

/* ================= INIT ================= */
function setCategory(cat) {
  currentCategory = cat
  loadMenu()
}

loadTables()
loadMenu()
</script>

</body>
</html>
