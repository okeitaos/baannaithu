<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-slate-900 text-white p-3 space-y-3">

<h1 class="text-xl font-bold text-center">üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</h1>

<!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ -->
<select id="tableSelect" class="w-full p-2 text-black rounded">
  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>
</select>

<!-- ‡∏´‡∏°‡∏ß‡∏î -->
<div id="categoryBar" class="flex gap-2 overflow-x-auto"></div>

<!-- ‡πÄ‡∏°‡∏ô‡∏π -->
<div id="menu" class="grid grid-cols-2 gap-2"></div>

<!-- ‡∏ö‡∏¥‡∏• -->
<div class="bg-slate-800 p-3 rounded">
  <div id="bill"></div>
  <div class="border-t border-slate-600 mt-2 pt-2 text-lg font-bold">
    ‡∏£‡∏ß‡∏°: <span id="total">0</span> ‡∏ö‡∏≤‡∏ó
  </div>
</div>

<!-- ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
<div class="flex gap-2">
  <button onclick="checkout('cash')" class="flex-1 bg-emerald-600 py-3 rounded">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
  <button onclick="checkout('transfer')" class="flex-1 bg-indigo-600 py-3 rounded">üì≤ ‡πÇ‡∏≠‡∏ô</button>
</div>

<button onclick="cancelOrder()" class="w-full bg-red-600 py-2 rounded">
  ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
</button>

<!-- ================= MODAL ‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô ================= -->
<div id="addonModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center">
  <div class="bg-slate-800 p-4 rounded w-80">
    <h2 id="addonTitle" class="font-bold mb-2 text-center"></h2>

    <label class="block">
      <input type="checkbox" id="addonSpecial"> ‡∏û‡∏¥‡πÄ‡∏®‡∏© +10
    </label>

    <label class="block mt-1">
      <input type="checkbox" id="addonMix" onchange="toggleMix()"> ‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥ +10
    </label>

    <select id="mixSelect" class="w-full text-black mt-1 hidden"></select>

    <button onclick="confirmAddon()" class="mt-3 bg-emerald-600 w-full py-2 rounded">
      ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ö‡∏¥‡∏•
    </button>

    <button onclick="closeAddon()" class="mt-2 bg-slate-600 w-full py-1 rounded">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  </div>
</div>

<!-- ================= MODAL ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ================= -->
<div id="payModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center">
  <div class="bg-slate-800 p-4 rounded w-80">
    <h2 id="payTitle" class="font-bold mb-2 text-center"></h2>

    <div id="transferBox" class="hidden text-center">
      <img id="ppQR" class="mx-auto w-56 mb-2">
      <button onclick="confirmPay('transfer')" class="bg-indigo-600 w-full py-2 rounded">
        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô
      </button>
    </div>

    <div id="cashBox" class="hidden">
      <input id="cashInput" type="number"
        class="w-full p-2 text-black rounded mb-2"
        placeholder="‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô"
        oninput="calcChange()">
      ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: <span id="changeText">0</span> ‡∏ö‡∏≤‡∏ó
      <button onclick="confirmPay('cash')" class="mt-2 bg-emerald-600 w-full py-2 rounded">
        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
      </button>
    </div>

    <button onclick="closePay()" class="mt-3 bg-red-600 w-full py-1 rounded">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss";
const PROMPTPAY_ID = "0936494961";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= SWEET ALERT ================= */
const Toast = Swal.mixin({
  toast:true,
  position:'top-end',
  showConfirmButton:false,
  timer:1500,
  background:'#1e293b',
  color:'#fff'
});

/* ================= STATE ================= */
let categories = [];
let products = [];
let tables = [];
let cart = [];
let currentProduct = null;

/* ================= INIT ================= */
async function init(){
  categories = (await db.from('categories').select('*')).data || [];
  products   = (await db.from('products').select('*').eq('active',true)).data || [];
  tables     = (await db.from('tables').select('*').eq('active',true)).data || [];

  renderCategories();
  if(categories.length) loadCategory(categories[0].name);
  loadTables();
}

/* ================= TABLES ================= */
function loadTables(){
  tableSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>';
  tables.forEach(t=>{
    tableSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
  });
}

/* ================= CATEGORY ================= */
function renderCategories(){
  categoryBar.innerHTML = '';
  categories.forEach(c=>{
    const btn = document.createElement('button');
    btn.className = 'bg-slate-700 px-4 py-2 rounded whitespace-nowrap';
    btn.innerText = c.name;
    btn.onclick = () => loadCategory(c.name);
    categoryBar.appendChild(btn);
  });
}

function loadCategory(cat){
  menu.innerHTML = '';
  products.filter(p=>p.category===cat).forEach(p=>{
    const b = document.createElement('button');
    b.className = 'bg-slate-700 p-3 rounded';
    b.innerText = `${p.name}\n${p.price} ‡∏ö‡∏≤‡∏ó`;
    b.onclick = ()=>addItem(p);
    menu.appendChild(b);
  });
}

/* ================= ADD ITEM ================= */
function addItem(p){
  if(p.category === '‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô'){
    currentProduct = p;
    addonTitle.innerText = `${p.name} (${p.price})`;
    buildMixOptions(p.name);
    addonModal.classList.replace('hidden','flex');
    return;
  }

  const found = cart.find(i=>i.name===p.name);
  if(found){
    found.qty++;
  }else{
    cart.push({ name:p.name, price:p.price, qty:1 });
  }
  renderBill();
}

/* ================= MIX ================= */
function buildMixOptions(main){
  mixSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏ú‡∏™‡∏° --</option>';
  products
    .filter(p=>p.category==='‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô' && p.name!==main)
    .forEach(p=>{
      mixSelect.innerHTML += `<option>${p.name}</option>`;
    });
}
function toggleMix(){
  mixSelect.classList.toggle('hidden', !addonMix.checked);
}

/* ================= CONFIRM ADDON ================= */
function confirmAddon(){
  let name = currentProduct.name;
  let price = currentProduct.price;
  let detail = [];

  if(addonSpecial.checked){
    price += 10;
    detail.push('‡∏û‡∏¥‡πÄ‡∏®‡∏©');
  }

  if(addonMix.checked){
    if(!mixSelect.value){
      Swal.fire({ icon:'info', title:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏ú‡∏™‡∏°' });
      return;
    }
    price += 10;
    detail.push(`‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥:${mixSelect.value}`);
  }

  if(detail.length) name += ` (${detail.join(', ')})`;

  const found = cart.find(i=>i.name===name);
  if(found){
    found.qty++;
  }else{
    cart.push({ name, price, qty:1 });
  }

  closeAddon();
  renderBill();
}

function closeAddon(){
  addonModal.classList.replace('flex','hidden');
  addonSpecial.checked = false;
  addonMix.checked = false;
  mixSelect.classList.add('hidden');
  mixSelect.value = '';
}

/* ================= BILL ================= */
function renderBill(){
  bill.innerHTML = '';
  let sum = 0;

  cart.forEach((i, idx)=>{
    const row = document.createElement('div');
    row.className = 'flex items-center gap-2 border-b border-slate-700 py-1';

    row.innerHTML = `
      <div class="flex-1 text-sm">${i.name}</div>

      <div class="flex items-center gap-1">
        <button class="bg-slate-600 px-2 rounded"
          onclick="changeQty(${idx}, -1)">‚àí</button>
        <span>${i.qty}</span>
        <button class="bg-slate-600 px-2 rounded"
          onclick="changeQty(${idx}, 1)">+</button>
      </div>

      <div class="w-16 text-right text-sm">
        ${i.price * i.qty}
      </div>

      <button class="text-red-500 px-2"
        onclick="removeItem(${idx})">‚úï</button>
    `;

    bill.appendChild(row);
    sum += i.price * i.qty;
  });

  total.innerText = sum;
}

function changeQty(index, diff){
  cart[index].qty += diff;
  if(cart[index].qty <= 0){
    cart.splice(index, 1);
  }
  renderBill();
}

function removeItem(index){
  cart.splice(index, 1);
  renderBill();
}

/* ================= PAYMENT ================= */
function checkout(type){
  if(!cart.length){
    Toast.fire({ icon:'info', title:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' });
    return;
  }
  if(!tableSelect.value){
    Swal.fire({ icon:'warning', title:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞' });
    return;
  }

  const sum = cart.reduce((s,i)=>s + i.price*i.qty, 0);
  payModal.classList.replace('hidden','flex');
  cashBox.classList.add('hidden');
  transferBox.classList.add('hidden');

  if(type==='transfer'){
    payTitle.innerText = `‡πÇ‡∏≠‡∏ô ${sum} ‡∏ö‡∏≤‡∏ó`;
    transferBox.classList.remove('hidden');
    ppQR.src = `https://promptpay.io/${PROMPTPAY_ID}/${sum.toFixed(2)}.png`;
  }else{
    payTitle.innerText = `‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ${sum} ‡∏ö‡∏≤‡∏ó`;
    cashBox.classList.remove('hidden');
    cashInput.value = '';
    changeText.innerText = '0';
  }
}

function calcChange(){
  const sum = cart.reduce((s,i)=>s + i.price*i.qty, 0);
  changeText.innerText = cashInput.value - sum;
}

async function confirmPay(type){
  const sum = cart.reduce((s,i)=>s + i.price*i.qty, 0);

  if(type==='cash' && Number(cashInput.value) < sum){
    Swal.fire({ icon:'error', title:'‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠' });
    return;
  }

  const { data: order } = await db.from('orders')
    .insert({
      total: sum,
      payment: type,
      table_id: tableSelect.value
    })
    .select()
    .single();

  for(const i of cart){
    await db.from('order_items').insert({
      order_id: order.id,
      product_name: i.name,
      price: i.price,
      qty: i.qty
    });
  }

  cart = [];
  renderBill();
  closePay();
  Swal.fire({ icon:'success', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' });
}

function closePay(){
  payModal.classList.replace('flex','hidden');
}

async function cancelOrder(){
  if(!cart.length) return;
  const r = await Swal.fire({
    title:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå?',
    showCancelButton:true,
    confirmButtonText:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
    cancelButtonText:'‡πÑ‡∏°‡πà‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
  });
  if(!r.isConfirmed) return;

  cart = [];
  renderBill();
  closePay();
  Toast.fire({ icon:'success', title:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß' });
}

/* ================= START ================= */
init();
</script>

</body>
</html>
