<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-slate-900 text-white p-3 space-y-3">

<h1 class="text-xl font-bold text-center">üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</h1>

<select id="tableSelect" class="w-full p-2 text-black rounded">
  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>
</select>

<div id="categoryBar" class="flex gap-2 overflow-x-auto"></div>
<div id="menu" class="grid grid-cols-2 gap-2"></div>

<div class="bg-slate-800 p-3 rounded">
  <div id="bill"></div>
  <div class="border-t mt-2 pt-2 text-lg font-bold">
    ‡∏£‡∏ß‡∏°: <span id="total">0</span> ‡∏ö‡∏≤‡∏ó
  </div>
</div>

<button onclick="sendToKitchen()"
  class="w-full bg-orange-500 py-3 rounded font-bold">
  üç≥ ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß
</button>

<button onclick="cancelOrder()"
  class="w-full bg-red-600 py-2 rounded">
  ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
</button>

<!-- ================= MODAL ADDON ================= -->
<div id="addonModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center">
  <div class="bg-slate-800 p-4 rounded w-80">
    <h2 id="addonTitle" class="font-bold mb-2 text-center"></h2>

    <label><input type="checkbox" id="addonSpecial"> ‡∏û‡∏¥‡πÄ‡∏®‡∏© +10</label><br>
    <label><input type="checkbox" id="addonMix" onchange="toggleMix()"> ‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥ +10</label>

    <select id="mixSelect" class="w-full text-black mt-1 hidden"></select>

    <button onclick="confirmAddon()" class="mt-3 bg-emerald-600 w-full py-2 rounded">
      ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ö‡∏¥‡∏•
    </button>

    <button onclick="closeAddon()" class="mt-2 bg-slate-600 w-full py-1 rounded">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= STATE ================= */
let categories=[], products=[], tables=[];
let cart=[], currentProduct=null;
let currentOrderId=null;

/* ================= INIT ================= */
async function init(){
  categories=(await db.from('categories').select('*')).data||[];
  products=(await db.from('products').select('*').eq('active',true)).data||[];
  tables=(await db.from('tables').select('*')).data||[];

  renderCategories();
  if(categories.length) loadCategory(categories[0].name);
  loadTables();
}

/* ================= TABLE ================= */
function loadTables(){
  tableSelect.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>';
  tables.forEach(t=>{
    tableSelect.innerHTML+=`<option value="${t.id}">${t.name}</option>`;
  });
}

/* ================= CATEGORY ================= */
function renderCategories(){
  categoryBar.innerHTML='';
  categories.forEach(c=>{
    const b=document.createElement('button');
    b.className='bg-slate-700 px-4 py-2 rounded';
    b.innerText=c.name;
    b.onclick=()=>loadCategory(c.name);
    categoryBar.appendChild(b);
  });
}

function loadCategory(cat){
  menu.innerHTML='';
  products.filter(p=>p.category===cat).forEach(p=>{
    const b=document.createElement('button');
    b.className='bg-slate-700 p-3 rounded';
    b.innerText=`${p.name}\n${p.price} ‡∏ö‡∏≤‡∏ó`;
    b.onclick=()=>addItem(p);
    menu.appendChild(b);
  });
}

/* ================= ADD ITEM ================= */
function addItem(p){
  if(p.category==='‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô'){
    currentProduct=p;
    addonTitle.innerText=`${p.name} (${p.price})`;
    buildMixOptions(p.name);
    addonModal.classList.replace('hidden','flex');
    return;
  }

  const f=cart.find(i=>i.name===p.name);
  f?f.qty++:cart.push({name:p.name,price:p.price,qty:1});
  renderBill();
}

function buildMixOptions(main){
  mixSelect.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏ú‡∏™‡∏° --</option>';
  products.filter(p=>p.category==='‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô'&&p.name!==main)
    .forEach(p=>mixSelect.innerHTML+=`<option>${p.name}</option>`);
}

function toggleMix(){
  mixSelect.classList.toggle('hidden',!addonMix.checked);
}

function confirmAddon(){
  let name=currentProduct.name, price=currentProduct.price, opt=[];
  if(addonSpecial.checked){price+=10;opt.push('‡∏û‡∏¥‡πÄ‡∏®‡∏©')}
  if(addonMix.checked){
    if(!mixSelect.value)return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡πâ‡∏≥');
    price+=10;opt.push(`‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥:${mixSelect.value}`);
  }
  if(opt.length)name+=` (${opt.join(', ')})`;
  const f=cart.find(i=>i.name===name);
  f?f.qty++:cart.push({name,price,qty:1});
  closeAddon();renderBill();
}

function closeAddon(){
  addonModal.classList.replace('flex','hidden');
  addonSpecial.checked=false;addonMix.checked=false;
  mixSelect.value='';mixSelect.classList.add('hidden');
}

/* ================= BILL ================= */
function renderBill(){
  bill.innerHTML='';let sum=0;
  cart.forEach((i,idx)=>{
    sum+=i.price*i.qty;
    bill.innerHTML+=`
      <div class="flex justify-between border-b py-1">
        ${i.name} √ó ${i.qty}
        <button onclick="removeItem(${idx})">‚úï</button>
      </div>`;
  });
  total.innerText=sum;
}

function removeItem(i){cart.splice(i,1);renderBill();}

/* ================= SEND TO KITCHEN ================= */
async function sendToKitchen(){
  if(!cart.length)return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
  if(!tableSelect.value)return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞');

  if(!currentOrderId){
    const {data}=await db.from('orders')
      .insert({table_id:tableSelect.value,status:'open'})
      .select().single();
    currentOrderId=data.id;
  }

  for(const i of cart){
    await db.from('order_items').insert({
      order_id:currentOrderId,
      product_name:i.name,
      price:i.price,
      qty:i.qty
    });
  }

  /* üî• ‡∏£‡∏µ‡πÄ‡∏ã‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡πÑ‡∏°‡πà‡∏£‡∏∑‡πâ‡∏≠ logic ‡πÄ‡∏î‡∏¥‡∏°) */
  cart=[];
  renderBill();
  closeAddon();

  Swal.fire({icon:'success',title:'‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß'});
}

/* ================= CANCEL ================= */
function cancelOrder(){
  cart=[];
  renderBill();
  closeAddon();
}

/* ================= START ================= */
init();
</script>

</body>
</html>
