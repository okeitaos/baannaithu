<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>üçú POS ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen p-4">

<div class="max-w-7xl mx-auto grid grid-cols-12 gap-4">

  <!-- ‡πÇ‡∏ï‡πä‡∏∞ -->
  <div class="col-span-3 bg-slate-800 rounded-xl p-4">
    <h2 class="font-bold mb-3">ü™ë ‡πÇ‡∏ï‡πä‡∏∞</h2>
    <div id="tableList" class="grid grid-cols-2 gap-2"></div>
  </div>

  <!-- ‡πÄ‡∏°‡∏ô‡∏π -->
  <div class="col-span-5 bg-slate-800 rounded-xl p-4">
    <h2 class="font-bold mb-2">üìã ‡πÄ‡∏°‡∏ô‡∏π</h2>

    <div class="flex gap-2 mb-3">
      <button id="btn-noodle" class="px-3 py-1 rounded bg-orange-600">üçú ‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</button>
      <button id="btn-drink" class="px-3 py-1 rounded bg-slate-600">ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</button>
      <button id="btn-snack" class="px-3 py-1 rounded bg-slate-600">üç¢ ‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</button>
    </div>

    <div id="menuList" class="space-y-3"></div>
  </div>

  <!-- ‡∏ö‡∏¥‡∏• -->
  <div class="col-span-4 bg-slate-800 rounded-xl p-4">
    <h2 class="font-bold mb-3">
      üßæ ‡πÇ‡∏ï‡πä‡∏∞ <span id="currentTable">-</span>
    </h2>

    <div id="orderItems" class="space-y-2 mb-4"></div>

    <div class="border-t pt-3 space-y-2">
      <div class="flex justify-between font-bold text-lg">
        <span>‡∏£‡∏ß‡∏°</span>
        <span id="totalPrice">0 ‡∏ø</span>
      </div>

      <button id="sendOrderBtn"
        class="w-full bg-green-600 py-2 rounded disabled:opacity-40"
        disabled>
        üü¢ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß
      </button>
    </div>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co"
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

/* ================= DOM (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î) ================= */
const tableList     = document.getElementById("tableList")
const menuList      = document.getElementById("menuList")
const orderItems    = document.getElementById("orderItems")
const currentTable  = document.getElementById("currentTable")
const totalPrice    = document.getElementById("totalPrice")

const btnNoodle     = document.getElementById("btn-noodle")
const btnDrink      = document.getElementById("btn-drink")
const btnSnack      = document.getElementById("btn-snack")
const sendOrderBtn  = document.getElementById("sendOrderBtn")

/* ================= STATE ================= */
let currentCategory = "‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô"
let selectedTableId = null
let currentOrderId  = null

let noodleMenus = []
const restrictedMixTargets = ["‡πÅ‡∏Å‡∏á‡∏õ‡∏π", "‡∏ô‡πâ‡∏≥‡∏ä‡∏∏‡∏ö‡∏´‡∏¢‡∏≥"]

/* ================= TABLES ================= */
async function loadTables() {
  const { data } = await sb.from("tables").select("*").order("table_no")
  tableList.innerHTML = ""

  ;(data || []).forEach(t => {
    const btn = document.createElement("button")
    btn.className =
      "p-2 rounded font-bold " +
      (selectedTableId === t.id ? "bg-yellow-500" :
       t.status === "occupied" ? "bg-red-600" : "bg-green-600")

    btn.textContent = "‡πÇ‡∏ï‡πä‡∏∞ " + t.table_no
    btn.onclick = () => selectTable(t)
    tableList.appendChild(btn)
  })
}

function selectTable(t) {
  if (currentOrderId && selectedTableId !== t.id) {
    alert("‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô")
    return
  }
  selectedTableId = t.id
  currentTable.textContent = t.table_no
  loadOrderItems()
  loadTables()
}

/* ================= CATEGORY ================= */
function setCategory(cat) {
  currentCategory = cat
  loadMenu()
}

btnNoodle.onclick = () => setCategory("‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô")
btnDrink.onclick  = () => setCategory("‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°")
btnSnack.onclick  = () => setCategory("‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô")

/* ================= MENU ================= */
async function loadMenu() {
  const { data: products } = await sb
    .from("products")
    .select("*")
    .eq("category", currentCategory)

  menuList.innerHTML = ""

  ;(products || []).forEach(p => {
    const div = document.createElement("div")
    div.className = "bg-slate-700 p-3 rounded flex justify-between"

    div.innerHTML = `
      <div>
        <div class="font-bold">${p.name}</div>
        <div>${p.price} ‡∏ö‡∏≤‡∏ó</div>
      </div>
      <button class="bg-blue-600 px-4 rounded">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    `

    div.querySelector("button").onclick = () => addItemDraft(p)
    menuList.appendChild(div)
  })
}

/* ================= ORDER ================= */
async function addItemDraft(p) {
  if (!selectedTableId) {
    alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡πà‡∏≠‡∏ô")
    return
  }

  if (!currentOrderId) {
    const { data } = await sb
      .from("orders")
      .insert({ table_id: selectedTableId })
      .select()
      .single()
    currentOrderId = data.id
  }

  await sb.from("order_items").insert({
    order_id: currentOrderId,
    product_id: p.id,
    price: p.price,
    status: "draft"
  })

  loadOrderItems()
}

async function loadOrderItems() {
  if (!currentOrderId) {
    orderItems.innerHTML = ""
    totalPrice.textContent = "0 ‡∏ø"
    sendOrderBtn.disabled = true
    return
  }

  const { data } = await sb
    .from("order_items")
    .select("id, price, status, products(name)")
    .eq("order_id", currentOrderId)

  let total = 0
  let hasDraft = false
  orderItems.innerHTML = ""

  ;(data || []).forEach(i => {
    total += i.price
    if (i.status === "draft") hasDraft = true

    const div = document.createElement("div")
    div.className = "bg-slate-700 p-2 rounded text-sm"
    div.textContent = `${i.products.name} (${i.status})`
    orderItems.appendChild(div)
  })

  totalPrice.textContent = total + " ‡∏ø"
  sendOrderBtn.disabled = !hasDraft
}

/* ================= SEND ORDER ================= */
sendOrderBtn.onclick = async () => {
  await sb.from("order_items")
    .update({ status: "pending" })
    .eq("order_id", currentOrderId)
    .eq("status", "draft")

  await sb.from("tables")
    .update({ status: "occupied", current_order_id: currentOrderId })
    .eq("id", selectedTableId)

  loadTables()
  loadOrderItems()
}

/* ================= INIT ================= */
loadTables()
loadMenu()
</script>

</body>
</html>
