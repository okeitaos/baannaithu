<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- QRCode Generator (‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå) -->
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.js"></script>
</head>

<body class="bg-slate-900 text-white p-3">

<h1 class="text-xl font-bold text-center mb-3">üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</h1>

<!-- ‡∏´‡∏°‡∏ß‡∏î -->
<div class="flex gap-2 mb-3">
  <button onclick="loadCategory('‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô')" class="flex-1 bg-orange-600 py-2 rounded">üçú ‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</button>
  <button onclick="loadCategory('‡∏ô‡πâ‡∏≥')" class="flex-1 bg-sky-600 py-2 rounded">üßä ‡∏ô‡πâ‡∏≥</button>
  <button onclick="loadCategory('‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô')" class="flex-1 bg-green-600 py-2 rounded">üçó ‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</button>
</div>

<!-- ‡πÄ‡∏°‡∏ô‡∏π -->
<div id="menu" class="grid grid-cols-2 gap-2 mb-3"></div>

<!-- ‡∏ö‡∏¥‡∏• -->
<div class="bg-slate-800 p-3 rounded mb-3">
  <div id="bill"></div>
  <div class="border-t border-slate-600 mt-2 pt-2 text-lg font-bold">
    ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="total">0</span> ‡∏ö‡∏≤‡∏ó
  </div>
</div>

<!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
<div class="flex gap-2">
  <button onclick="checkout('cash')" class="flex-1 bg-emerald-600 py-3 rounded text-lg">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
  <button onclick="checkout('transfer')" class="flex-1 bg-indigo-600 py-3 rounded text-lg">üì≤ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
</div>

<!-- MODAL -->
<div id="payModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center">
  <div class="bg-slate-800 p-4 rounded w-80">
    <h2 id="payTitle" class="text-lg font-bold mb-3 text-center"></h2>

    <!-- ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô -->
    <div id="transferBox" class="hidden text-center">
      <div id="qrBox" class="flex justify-center mb-3"></div>
      <div class="text-sm opacity-80 mb-2">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
      <button onclick="confirmPay('transfer')" class="bg-indigo-600 w-full py-2 rounded">
        ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô
      </button>
    </div>

    <!-- ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î -->
    <div id="cashBox" class="hidden">
      <label class="block mb-1">‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</label>
      <input id="cashInput" type="number"
        class="w-full p-2 text-black rounded mb-2"
        oninput="calcChange()">

      <div class="mb-2">
        ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: <span id="changeText">0</span> ‡∏ö‡∏≤‡∏ó
      </div>

      <button onclick="confirmPay('cash')" class="bg-emerald-600 w-full py-2 rounded">
        ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
      </button>
    </div>

    <button onclick="closeModal()" class="mt-3 w-full bg-slate-600 py-1 rounded">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss";
const PROMPTPAY_ID = "0936494961"; // üî¥ ‡πÉ‡∏™‡πà PromptPay ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì

const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let products = [];
let cart = [];

/* ================= LOAD PRODUCTS ================= */
async function loadProducts() {
  const { data, error } = await db.from('products').select('*').eq('active', true);
  if (error) {
    alert('‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    console.error(error);
    return;
  }
  products = data;
  loadCategory('‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô');
}

/* ================= CATEGORY ================= */
function loadCategory(cat) {
  const menu = document.getElementById('menu');
  menu.innerHTML = '';
  products.filter(p => p.category === cat).forEach(p => {
    const btn = document.createElement('button');
    btn.className = "bg-slate-700 p-4 rounded text-center";
    btn.innerHTML = `<div class="text-lg">${p.name}</div><div>${p.price} ‡∏ö‡∏≤‡∏ó</div>`;
    btn.onclick = () => addItem(p);
    menu.appendChild(btn);
  });
}

/* ================= CART ================= */
function addItem(p) {
  const item = cart.find(i => i.id === p.id);
  item ? item.qty++ : cart.push({ ...p, qty: 1 });
  renderBill();
}

function renderBill() {
  const bill = document.getElementById('bill');
  bill.innerHTML = '';
  let total = 0;
  cart.forEach(i => {
    const sum = i.price * i.qty;
    total += sum;
    bill.innerHTML += `<div>${i.name} x${i.qty} = ${sum}</div>`;
  });
  document.getElementById('total').innerText = total;
}

/* ================= PAYMENT ================= */
function checkout(type) {
  if (!cart.length) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);

  document.getElementById('payModal').classList.remove('hidden');
  document.getElementById('payModal').classList.add('flex');
  document.getElementById('cashBox').classList.add('hidden');
  document.getElementById('transferBox').classList.add('hidden');

  if (type === 'transfer') {
    document.getElementById('payTitle').innerText = `üì≤ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ${total} ‡∏ö‡∏≤‡∏ó`;
    document.getElementById('transferBox').classList.remove('hidden');
    genQR(total);
  } else {
    document.getElementById('payTitle').innerText = `üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ${total} ‡∏ö‡∏≤‡∏ó`;
    document.getElementById('cashBox').classList.remove('hidden');
    document.getElementById('cashInput').value = '';
    document.getElementById('changeText').innerText = '0';
  }
}

function closeModal() {
  document.getElementById('payModal').classList.add('hidden');
}

function calcChange() {
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  const cash = Number(document.getElementById('cashInput').value || 0);
  document.getElementById('changeText').innerText = cash - total;
}

/* ================= CONFIRM ================= */
async function confirmPay(type) {
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  if (type === 'cash') {
    const cash = Number(document.getElementById('cashInput').value || 0);
    if (cash < total) return alert('‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠');
  }

  const { data: order, error } = await db
    .from('orders')
    .insert({ total, payment: type })
    .select()
    .single();

  if (error) {
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    console.error(error);
    return;
  }

  for (const i of cart) {
    await db.from('order_items').insert({
      order_id: order.id,
      product_name: i.name,
      qty: i.qty,
      price: i.price
    });
  }

  cart = [];
  renderBill();
  closeModal();
  alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
}

/* ================= PROMPTPAY QR ================= */
function genQR(amount) {
  const payload = genPromptPayPayload(PROMPTPAY_ID, amount);
  const qr = qrcode(0, 'M');
  qr.addData(payload);
  qr.make();
  document.getElementById('qrBox').innerHTML = qr.createSvgTag(6, 6);
}

function genPromptPayPayload(id, amount) {
  function f(i,v){return i+v.length.toString().padStart(2,'0')+v}
  let p="000201"
    +f("01","12")
    +f("29",f("00","A000000677010111")+f("01",id))
    +f("53","764")
    +f("54",amount.toFixed(2))
    +f("58","TH")
    +f("62",f("07","POS"))
    +"6304";
  return p+crc16(p).toString(16).toUpperCase().padStart(4,'0');
}

function crc16(s){
  let c=0xFFFF;
  for(let ch of s){
    c^=ch.charCodeAt(0)<<8;
    for(let i=0;i<8;i++){
      c=c&0x8000?(c<<1)^0x1021:c<<1;
    }
  }
  return c&0xFFFF;
}

loadProducts();
</script>

</body>
</html>
