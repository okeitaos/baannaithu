<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{
  background:#020617;
  color:#e5e7eb;
}
button{ font-weight:600 }
</style>
</head>

<body class="p-3 space-y-3">

<h1 class="text-xl font-bold text-center">üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</h1>

<!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ -->
<select id="tableSelect" class="w-full p-2 text-black rounded"></select>

<!-- ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏î‡∏™‡∏≠‡∏ö -->
<div class="grid grid-cols-2 gap-2">
  <button onclick="addItem('‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô‡∏ô‡πâ‡∏≥‡∏¢‡∏≤',40)" class="bg-slate-700 p-3 rounded">‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô‡∏ô‡πâ‡∏≥‡∏¢‡∏≤</button>
  <button onclick="addItem('‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô‡πÅ‡∏Å‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏≤‡∏ô',45)" class="bg-slate-700 p-3 rounded">‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô‡πÅ‡∏Å‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏ß‡∏≤‡∏ô</button>
</div>

<!-- ‡∏ö‡∏¥‡∏• -->
<div class="bg-slate-800 p-3 rounded">
  <div id="bill"></div>
  <div class="border-t mt-2 pt-2 text-lg">
    ‡∏£‡∏ß‡∏°: <span id="total" class="text-emerald-400">0</span> ‡∏ö‡∏≤‡∏ó
  </div>
</div>

<!-- ‡∏õ‡∏∏‡πà‡∏° -->
<div class="grid grid-cols-3 gap-2">
  <button onclick="sendToKitchen()" class="bg-indigo-600 py-2 rounded">üë®‚Äçüç≥ ‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏ß</button>
  <button onclick="checkout()" class="bg-emerald-600 py-2 rounded">üí∞ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ö‡∏¥‡∏•</button>
  <button onclick="cancelBill()" class="bg-red-600 py-2 rounded">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= STATE ================= */
let tables = [];
let cart = [];
let currentTable = null;
let currentOrderId = null;

/* ================= INIT ================= */
async function init(){
  await loadTables();
}
init();

/* ================= TABLE ================= */
async function loadTables(){
  const { data } = await db.from('tables').select('*').order('name');
  tables = data || [];

  tableSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>';
  tables.forEach(t=>{
    const icon = t.status === 'busy' ? 'üî¥' : 'üü¢';
    tableSelect.innerHTML += `<option value="${t.id}">${icon} ${t.name}</option>`;
  });
}

tableSelect.onchange = async ()=>{
  if(!tableSelect.value) return;

  currentTable = tableSelect.value;
  cart = [];

  // ‡∏´‡∏≤ order ‡∏Ñ‡πâ‡∏≤‡∏á
  const { data: order } = await db
    .from('orders')
    .select('*')
    .eq('table_id', currentTable)
    .eq('status','open')
    .single();

  if(order){
    currentOrderId = order.id;
    const { data: items } = await db
      .from('order_items')
      .select('*')
      .eq('order_id', order.id);

    cart = items.map(i=>({
      name:i.product_name,
      price:i.price,
      qty:i.qty
    }));
  }else{
    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞‡πÉ‡∏´‡∏°‡πà
    const { data:newOrder } = await db.from('orders')
      .insert({ table_id:currentTable, status:'open', total:0 })
      .select().single();

    currentOrderId = newOrder.id;
    await db.from('tables').update({ status:'busy' }).eq('id',currentTable);
  }

  renderBill();
  loadTables();
};

/* ================= BILL ================= */
function addItem(name,price){
  if(!currentTable){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞');
    return;
  }
  const f = cart.find(i=>i.name===name);
  f ? f.qty++ : cart.push({name,price,qty:1});
  renderBill();
}

function renderBill(){
  bill.innerHTML='';
  let sum=0;
  cart.forEach(i=>{
    bill.innerHTML += `
      <div class="flex justify-between border-b py-1">
        <span>${i.name} √ó ${i.qty}</span>
        <span>${i.price*i.qty}</span>
      </div>`;
    sum += i.price*i.qty;
  });
  total.textContent = sum;
}

/* ================= SEND TO KITCHEN ================= */
async function sendToKitchen(){
  if(!cart.length) return;

  await db.from('order_items').delete().eq('order_id',currentOrderId);

  for(const i of cart){
    await db.from('order_items').insert({
      order_id:currentOrderId,
      product_name:i.name,
      price:i.price,
      qty:i.qty
    });
  }

  const sum = cart.reduce((s,i)=>s+i.price*i.qty,0);
  await db.from('orders').update({ total:sum }).eq('id',currentOrderId);

  Swal.fire('‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß','','success');
}

/* ================= CHECKOUT ================= */
async function checkout(){
  if(!currentOrderId) return;

  await db.from('orders')
    .update({ status:'paid' })
    .eq('id',currentOrderId);

  await db.from('tables')
    .update({ status:'free' })
    .eq('id',currentTable);

  resetAll();
  Swal.fire('‡πÄ‡∏ä‡πá‡∏Ñ‡∏ö‡∏¥‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','','success');
}

/* ================= CANCEL ================= */
async function cancelBill(){
  if(!currentOrderId) return;

  await db.from('orders')
    .update({ status:'cancel' })
    .eq('id',currentOrderId);

  await db.from('order_items')
    .delete()
    .eq('order_id',currentOrderId);

  await db.from('tables')
    .update({ status:'free' })
    .eq('id',currentTable);

  resetAll();
  Swal.fire('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß','','success');
}

/* ================= RESET ================= */
function resetAll(){
  cart=[];
  currentOrderId=null;
  currentTable=null;
  tableSelect.value='';
  renderBill();
  loadTables();
}
</script>

</body>
</html>
