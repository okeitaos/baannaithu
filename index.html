<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>üçú POS ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen p-4">

<div class="max-w-7xl mx-auto grid grid-cols-12 gap-4">

  <!-- ================= ‡πÇ‡∏ï‡πä‡∏∞ ================= -->
  <div class="col-span-3 bg-slate-800 rounded-xl p-4">
    <h2 class="font-bold mb-3">ü™ë ‡πÇ‡∏ï‡πä‡∏∞</h2>
    <div id="tableList" class="grid grid-cols-2 gap-2"></div>
  </div>

  <!-- ================= ‡πÄ‡∏°‡∏ô‡∏π ================= -->
  <div class="col-span-5 bg-slate-800 rounded-xl p-4">
    <h2 class="font-bold mb-2">üìã ‡πÄ‡∏°‡∏ô‡∏π</h2>

    <div class="flex gap-2 mb-3">
      <button id="btn-noodle" class="px-3 py-1 rounded bg-orange-600">üçú ‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</button>
      <button id="btn-drink" class="px-3 py-1 rounded bg-slate-600">ü•§ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</button>
      <button id="btn-snack" class="px-3 py-1 rounded bg-slate-600">üç¢ ‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</button>
    </div>

    <div id="menuList" class="space-y-3"></div>
  </div>

  <!-- ================= ‡∏ö‡∏¥‡∏• ================= -->
  <div class="col-span-4 bg-slate-800 rounded-xl p-4">
    <h2 class="font-bold mb-3">
      üßæ ‡πÇ‡∏ï‡πä‡∏∞ <span id="currentTable">-</span>
    </h2>

    <div id="orderItems" class="space-y-2 mb-4"></div>

    <div class="border-t pt-3">
      <div class="flex justify-between font-bold text-lg">
        <span>‡∏£‡∏ß‡∏°</span>
        <span id="totalPrice">0 ‡∏ø</span>
      </div>
    </div>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co"
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

/* ================= STATE ================= */
let currentCategory = "‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô"

let selectedTableId = null
let selectedTableNo = null
let currentOrderId = null

let noodleMenus = []
const restrictedMixTargets = ["‡πÅ‡∏Å‡∏á‡∏õ‡∏π", "‡∏ô‡πâ‡∏≥‡∏ä‡∏∏‡∏ö‡∏´‡∏¢‡∏≥"]

/* ================= LOAD TABLES ================= */
async function loadTables() {
  const { data, error } = await sb
    .from("tables")
    .select("*")
    .order("table_no")

  if (error) {
    alert("‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ï‡πä‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ")
    console.error(error)
    return
  }

  tableList.innerHTML = ""

  data.forEach(t => {
    const btn = document.createElement("button")

    let cls = "p-2 rounded font-bold "
    if (selectedTableId === t.id) cls += "bg-yellow-500"
    else if (t.status === "occupied") cls += "bg-red-600"
    else cls += "bg-green-600"

    btn.className = cls
    btn.textContent = "‡πÇ‡∏ï‡πä‡∏∞ " + t.table_no

    btn.onclick = () => selectTable(t)

    tableList.appendChild(btn)
  })
}

/* ================= SELECT TABLE ================= */
function selectTable(t) {
  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ order ‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏ï‡πä‡∏∞
  if (currentOrderId && selectedTableId !== t.id) {
    alert("‚ùå ‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô")
    return
  }

  selectedTableId = t.id
  selectedTableNo = t.table_no
  currentTable.textContent = t.table_no

  if (t.status === "occupied" && t.current_order_id) {
    currentOrderId = t.current_order_id
    loadOrderItems()
  } else {
    currentOrderId = null
    orderItems.innerHTML = ""
    totalPrice.textContent = "0 ‡∏ø"
  }

  loadTables()
}

/* ================= CATEGORY ================= */
function setCategory(cat) {
  currentCategory = cat

  btnNoodle.className = "px-3 py-1 rounded bg-slate-600"
  btnDrink.className  = "px-3 py-1 rounded bg-slate-600"
  btnSnack.className  = "px-3 py-1 rounded bg-slate-600"

  if (cat === "‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô") btnNoodle.className = "px-3 py-1 rounded bg-orange-600"
  if (cat === "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°") btnDrink.className = "px-3 py-1 rounded bg-blue-600"
  if (cat === "‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô") btnSnack.className = "px-3 py-1 rounded bg-green-600"

  loadMenu()
}

/* ================= MIX RULE ================= */
function getAllowedMixOptions(mainName) {
  if (restrictedMixTargets.includes(mainName)) {
    return noodleMenus.filter(n => n.name !== mainName)
  }
  return noodleMenus.filter(
    n => !restrictedMixTargets.includes(n.name) && n.name !== mainName
  )
}

/* ================= LOAD MENU ================= */
async function loadMenu() {
  const { data: products } = await sb
    .from("products")
    .select("*")
    .eq("active", true)
    .eq("category", currentCategory)
    .order("price")

  const { data: noodles } = await sb
    .from("products")
    .select("*")
    .eq("active", true)
    .eq("category", "‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô")

  noodleMenus = noodles || []
  menuList.innerHTML = ""

  ;(products || []).forEach(p => {
    const card = document.createElement("div")
    card.className = "bg-slate-700 p-3 rounded relative"

    let options = ""
    if (p.category === "‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô") {
      options += `
        <label class="block text-sm mt-2">
          <input type="checkbox" id="sp_${p.id}"> ‡∏û‡∏¥‡πÄ‡∏®‡∏© (+10)
        </label>
      `
      const mixes = getAllowedMixOptions(p.name)
      if (mixes.length) {
        options += `
          <label class="block text-sm mt-1">
            ‡∏ú‡∏™‡∏° (+10)
            <select id="mix_${p.id}" class="text-black ml-1">
              <option value="">-- ‡πÑ‡∏°‡πà‡∏ú‡∏™‡∏° --</option>
              ${mixes.map(m => `<option value="${m.id}">${m.name}</option>`).join("")}
            </select>
          </label>
        `
      }
    }

    card.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <div class="font-bold">${p.name}</div>
          <div class="text-sm">${p.price} ‡∏ö‡∏≤‡∏ó</div>
        </div>
        <button class="add-btn bg-blue-600 px-4 py-2 rounded z-10 relative">
          ‡πÄ‡∏û‡∏¥‡πà‡∏°
        </button>
      </div>
      ${options}
    `

    card.querySelector(".add-btn").onclick = () => addItem(p)

    menuList.appendChild(card)
  })
}

/* ================= ADD ITEM ================= */
async function addItem(p) {
  if (!selectedTableId) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡πà‡∏≠‡∏ô")
    return
  }

  // ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á order + ‡∏•‡πá‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞
  if (!currentOrderId) {
    const { data: order, error } = await sb
      .from("orders")
      .insert({ table_id: selectedTableId })
      .select()
      .single()

    if (error) {
      alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
      console.error(error)
      return
    }

    await sb.from("tables")
      .update({
        status: "occupied",
        current_order_id: order.id
      })
      .eq("id", selectedTableId)

    currentOrderId = order.id
    loadTables()
  }

  const sp = document.getElementById("sp_" + p.id)?.checked || false
  const mixId = document.getElementById("mix_" + p.id)?.value || null

  let price = p.price
  if (sp) price += 10
  if (mixId) price += 10

  const { error } = await sb
    .from("order_items")
    .insert({
      order_id: currentOrderId,
      product_id: p.id,
      price,
      option_special: sp,
      option_mix: !!mixId,
      mix_sauce_id: mixId
    })

  if (error) {
    alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
    console.error(error)
    return
  }

  loadOrderItems()
}

/* ================= LOAD ORDER ITEMS ================= */
async function loadOrderItems() {
  if (!currentOrderId) return

  const { data } = await sb
    .from("order_items")
    .select(`
      price,
      products(name),
      mix:mix_sauce_id(name)
    `)
    .eq("order_id", currentOrderId)

  let total = 0
  orderItems.innerHTML = ""

  ;(data || []).forEach(i => {
    total += i.price
    const div = document.createElement("div")
    div.className = "bg-slate-700 p-2 rounded text-sm"
    div.textContent =
      i.products.name +
      (i.mix ? ` (‡∏ú‡∏™‡∏° ${i.mix.name})` : "")
    orderItems.appendChild(div)
  })

  totalPrice.textContent = total + " ‡∏ø"
}

/* ================= INIT ================= */
const btnNoodle = document.getElementById("btn-noodle")
const btnDrink  = document.getElementById("btn-drink")
const btnSnack  = document.getElementById("btn-snack")

btnNoodle.onclick = () => setCategory("‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô")
btnDrink.onclick  = () => setCategory("‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°")
btnSnack.onclick  = () => setCategory("‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô")

loadTables()
loadMenu()
</script>

</body>
</html>
