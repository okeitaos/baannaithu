<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{background:#020617;color:#e5e7eb}
button{font-weight:600}
</style>
</head>

<body class="p-3 space-y-3">

<h1 class="text-xl font-bold text-center">üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</h1>

<select id="tableSelect" class="w-full p-2 text-black rounded"
 onchange="selectTable()">
 <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>
</select>

<div id="menu" class="grid grid-cols-2 gap-2"></div>

<div class="bg-slate-800 p-3 rounded space-y-2">
 <div id="bill"></div>
 <div class="border-t pt-2 font-bold">
  ‡∏£‡∏ß‡∏°: <span id="total">0</span> ‡∏ö‡∏≤‡∏ó
 </div>

 <button onclick="sendToKitchen()"
  class="w-full bg-orange-500 py-2 rounded">
  üî• ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß
 </button>
</div>

<div class="flex gap-2">
 <button onclick="checkout('cash')"
  class="flex-1 bg-emerald-600 py-3 rounded">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
 <button onclick="checkout('transfer')"
  class="flex-1 bg-indigo-600 py-3 rounded">üì≤ ‡πÇ‡∏≠‡∏ô</button>
</div>

<script>
/* ===== CONFIG ===== */
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss";
const PROMPTPAY_ID = "0869525072";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== STATE ===== */
let tables=[], products=[], currentOrder=null;

/* ===== INIT ===== */
async function init(){
  tables=(await db.from('tables').select('*')).data;
  products=(await db.from('products').select('*').eq('active',true)).data;

  tableSelect.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>';
  tables.forEach(t=>{
    tableSelect.innerHTML+=
     `<option value="${t.id}">${t.name} (${t.status})</option>`;
  });

  products.forEach(p=>{
    const b=document.createElement('button');
    b.className='bg-slate-700 p-3 rounded';
    b.innerText=`${p.name}\n${p.price} ‡∏ö‡∏≤‡∏ó`;
    b.onclick=()=>addItem(p);
    menu.appendChild(b);
  });
}
init();

/* ===== TABLE ===== */
async function selectTable(){
 const tableId=tableSelect.value;
 if(!tableId) return;

 const { data } = await db.from('orders')
  .select('*')
  .eq('table_id',tableId)
  .eq('status','open')
  .maybeSingle();

 currentOrder=data||null;
 loadBill();
}

/* ===== ADD ITEM ===== */
async function addItem(p){
 if(!currentOrder){
  const { data } = await db.from('orders')
   .insert({table_id:tableSelect.value})
   .select().single();
  currentOrder=data;
  await db.from('tables')
   .update({status:'busy'})
   .eq('id',tableSelect.value);
 }

 const { error } = await db.from('order_items').insert({
  order_id:currentOrder.id,
  product_name:p.name,
  price:Number(p.price),
  qty:1,
  status:'draft'
 });

 if(error){
  console.error(error);
  Swal.fire(error.message);
 }
 loadBill();
}

/* ===== BILL ===== */
async function loadBill(){
 if(!currentOrder){bill.innerHTML='';total.innerText=0;return;}

 const { data } = await db.from('order_items')
  .select('*')
  .eq('order_id',currentOrder.id);

 let sum=0;
 bill.innerHTML='';
 data.forEach(i=>{
  bill.innerHTML+=`<div>${i.product_name} x ${i.qty}</div>`;
  sum+=i.price*i.qty;
 });
 total.innerText=sum;
}

/* ===== SEND KITCHEN ===== */
async function sendToKitchen(){
 if(!currentOrder) return;
 await db.from('order_items')
  .update({status:'sent'})
  .eq('order_id',currentOrder.id)
  .eq('status','draft');
 Swal.fire('‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß');
}

/* ===== PAYMENT ===== */
function checkout(type){
 if(!currentOrder) return;
 const sum=Number(total.innerText);
 if(type==='transfer'){
  Swal.fire({
   title:'‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢',
   html:`<img src="https://promptpay.io/${PROMPTPAY_ID}/${sum}.png">`,
   confirmButtonText:'‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß'
  }).then(confirmPay);
 }else{
  Swal.fire({
   title:`‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${sum}`,
   confirmButtonText:'‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß'
  }).then(confirmPay);
 }
}

async function confirmPay(){
 await db.from('orders')
  .update({status:'paid',total:Number(total.innerText)})
  .eq('id',currentOrder.id);

 await db.from('tables')
  .update({status:'free'})
  .eq('id',tableSelect.value);

 currentOrder=null;
 loadBill();
 Swal.fire('‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
}
</script>

</body>
</html>
