<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white p-3">

<h1 class="text-xl font-bold text-center mb-3">üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</h1>

<!-- ‡∏´‡∏°‡∏ß‡∏î -->
<div class="flex gap-2 mb-3">
  <button onclick="loadCategory('‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô')" class="flex-1 bg-orange-600 py-2 rounded">‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</button>
  <button onclick="loadCategory('‡∏ô‡πâ‡∏≥')" class="flex-1 bg-sky-600 py-2 rounded">‡∏ô‡πâ‡∏≥</button>
  <button onclick="loadCategory('‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô')" class="flex-1 bg-green-600 py-2 rounded">‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</button>
</div>

<!-- ‡πÄ‡∏°‡∏ô‡∏π -->
<div id="menu" class="grid grid-cols-2 gap-2 mb-3"></div>

<!-- ‡∏ö‡∏¥‡∏• -->
<div class="bg-slate-800 p-3 rounded mb-3">
  <div id="bill"></div>
  <div class="border-t border-slate-600 mt-2 pt-2 text-lg font-bold">
    ‡∏£‡∏ß‡∏°: <span id="total">0</span> ‡∏ö‡∏≤‡∏ó
  </div>
</div>

<!-- ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
<div class="flex gap-2">
  <button onclick="checkout('cash')" class="flex-1 bg-emerald-600 py-3 rounded text-lg">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
  <button onclick="checkout('transfer')" class="flex-1 bg-indigo-600 py-3 rounded text-lg">üì≤ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
</div>

<script>
/* üîë 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á client (‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ db ‡πÅ‡∏ó‡∏ô supabase) */
const db = supabase.createClient(
  "https://nvsptbbvxjulrpdebrhn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
);

let products = [];
let cart = [];

/* üîë 2. ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π */
async function loadProducts() {
  const { data, error } = await db
    .from('products')
    .select('*')
    .eq('active', true);

  if (error) {
    alert('‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    console.error(error);
    return;
  }

  products = data;
  loadCategory('‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô');
}

/* üîë 3. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏°‡∏ß‡∏î */
function loadCategory(cat) {
  const menu = document.getElementById('menu');
  menu.innerHTML = '';

  products
    .filter(p => p.category === cat)
    .forEach(p => {
      const btn = document.createElement('button');
      btn.className = "bg-slate-700 p-4 rounded text-center";
      btn.innerHTML = `
        <div class="text-lg">${p.name}</div>
        <div>${p.price} ‡∏ö‡∏≤‡∏ó</div>
      `;
      btn.onclick = () => addItem(p);
      menu.appendChild(btn);
    });
}

/* üîë 4. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
function addItem(p) {
  const item = cart.find(i => i.id === p.id);
  if (item) item.qty++;
  else cart.push({ ...p, qty: 1 });
  renderBill();
}

/* üîë 5. ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏¥‡∏• */
function renderBill() {
  const bill = document.getElementById('bill');
  bill.innerHTML = '';
  let total = 0;

  cart.forEach(i => {
    const sum = i.price * i.qty;
    total += sum;
    bill.innerHTML += `<div>${i.name} x${i.qty} = ${sum}</div>`;
  });

  document.getElementById('total').innerText = total;
}

/* üîë 6. ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô */
async function checkout(payment) {
  if (cart.length === 0) {
    alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    return;
  }

  const total = cart.reduce((s, i) => s + i.price * i.qty, 0);

  const { data: order, error } = await db
    .from('orders')
    .insert({ total, payment })
    .select()
    .single();

  if (error) {
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    console.error(error);
    return;
  }

  for (const i of cart) {
    await db.from('order_items').insert({
      order_id: order.id,
      product_name: i.name,
      qty: i.qty,
      price: i.price
    });
  }

  cart = [];
  renderBill();
  alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
}

/* üîë ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
loadProducts();
</script>

</body>
</html>
