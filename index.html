<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{background:#020617;color:#e5e7eb}
button{font-weight:600}
</style>
</head>

<body class="p-3 space-y-3">

<h1 class="text-xl font-bold text-center">üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</h1>

<!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ -->
<select id="tableSelect" class="w-full p-2 text-black rounded"
 onchange="selectTable()">
 <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>
</select>

<!-- ‡∏´‡∏°‡∏ß‡∏î -->
<div id="categoryBar" class="flex gap-2 overflow-x-auto"></div>

<!-- ‡πÄ‡∏°‡∏ô‡∏π -->
<div id="menu" class="grid grid-cols-2 gap-2"></div>

<!-- ‡∏ö‡∏¥‡∏• -->
<div class="bg-slate-800 p-3 rounded space-y-2">
 <div id="bill"></div>

 <div class="border-t pt-2 font-bold">
  ‡∏£‡∏ß‡∏°: <span id="total">0</span> ‡∏ö‡∏≤‡∏ó
 </div>

 <button onclick="sendToKitchen()"
  class="w-full bg-orange-500 py-2 rounded">
  üî• ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß
 </button>
</div>

<!-- ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
<div class="flex gap-2">
 <button onclick="checkout('cash')"
  class="flex-1 bg-emerald-600 py-3 rounded">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
 <button onclick="checkout('promptpay')"
  class="flex-1 bg-indigo-600 py-3 rounded">üì≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</button>
</div>

<!-- ================= MODAL ADDON ================= -->
<div id="addonModal"
 class="fixed inset-0 bg-black/70 hidden items-center justify-center">
 <div class="bg-slate-800 p-4 rounded w-80 space-y-2">
  <h2 id="addonTitle" class="font-bold text-center"></h2>

  <label class="block">
   <input type="checkbox" id="addonSpecial"> ‡∏û‡∏¥‡πÄ‡∏®‡∏© +10
  </label>

  <label class="block">
   <input type="checkbox" id="addonMix" onchange="toggleMix()"> ‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥ +10
  </label>

  <select id="mixSelect"
   class="w-full text-black hidden"></select>

  <button onclick="confirmAddon()"
   class="bg-emerald-600 w-full py-2 rounded">
   ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ö‡∏¥‡∏•
  </button>

  <button onclick="closeAddon()"
   class="bg-slate-600 w-full py-1 rounded">
   ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
  </button>
 </div>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss";
const PROMPTPAY_ID = "0869525072";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= STATE ================= */
let categories=[], products=[], tables=[];
let currentOrder=null;
let currentPayment=null;
let currentProduct=null;

/* ================= INIT ================= */
async function init(){
 categories=(await db.from('categories').select('*')).data||[];
 products=(await db.from('products').select('*').eq('active',true)).data||[];
 tables=(await db.from('tables').select('*')).data||[];

 renderTables();
 renderCategories();
}
init();

/* ================= TABLE ================= */
function renderTables(){
 tableSelect.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>';
 tables.forEach(t=>{
  tableSelect.innerHTML+=`
   <option value="${t.id}">${t.name} (${t.status})</option>`;
 });
}

async function selectTable(){
 const tableId=tableSelect.value;
 if(!tableId) return;

 const { data } = await db.from('orders')
  .select('*')
  .eq('table_id',tableId)
  .eq('status','open')
  .maybeSingle();

 currentOrder=data||null;
 loadBill();
}

/* ================= CATEGORY ================= */
function renderCategories(){
 categoryBar.innerHTML='';
 categories.forEach(c=>{
  const b=document.createElement('button');
  b.className='bg-slate-700 px-4 py-2 rounded';
  b.innerText=c.name;
  b.onclick=()=>loadCategory(c.name);
  categoryBar.appendChild(b);
 });
}

function loadCategory(cat){
 menu.innerHTML='';
 products.filter(p=>p.category===cat).forEach(p=>{
  const b=document.createElement('button');
  b.className='bg-slate-700 p-3 rounded';
  b.innerText=`${p.name}\n${p.price} ‡∏ö‡∏≤‡∏ó`;
  b.onclick=()=>addItem(p);
  menu.appendChild(b);
 });
}

/* ================= ADD ITEM ================= */
async function addItem(p){
 if(!currentOrder){
  const { data } = await db.from('orders')
   .insert({table_id:tableSelect.value,status:'open'})
   .select().single();
  currentOrder=data;
  await db.from('tables')
   .update({status:'busy'})
   .eq('id',tableSelect.value);
 }

 if(p.category==='‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô'){
  currentProduct=p;
  addonTitle.innerText=p.name;
  buildMixOptions(p.name);
  addonModal.classList.replace('hidden','flex');
  return;
 }

 await insertItem(p.name,p.price);
 loadBill();
}

async function insertItem(name,price){
 await db.from('order_items').insert({
  order_id:currentOrder.id,
  product_name:name,
  price:Number(price),
  qty:1,
  status:'draft'
 });
}

/* ================= ADDON ================= */
function buildMixOptions(main){
 mixSelect.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡πâ‡∏≥ --</option>';
 products.filter(p=>p.category==='‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô'&&p.name!==main)
  .forEach(p=>mixSelect.innerHTML+=`<option>${p.name}</option>`);
}

function toggleMix(){
 mixSelect.classList.toggle('hidden',!addonMix.checked);
}

async function confirmAddon(){
 let name=currentProduct.name;
 let price=currentProduct.price;
 let opt=[];

 if(addonSpecial.checked){price+=10;opt.push('‡∏û‡∏¥‡πÄ‡∏®‡∏©')}
 if(addonMix.checked){
  if(!mixSelect.value){alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡πâ‡∏≥');return;}
  price+=10;opt.push(`‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥:${mixSelect.value}`);
 }

 if(opt.length) name+=` (${opt.join(', ')})`;

 await insertItem(name,price);
 closeAddon();
 loadBill();
}

function closeAddon(){
 addonModal.classList.replace('flex','hidden');
 addonSpecial.checked=false;
 addonMix.checked=false;
 mixSelect.classList.add('hidden');
}

/* ================= BILL ================= */
async function loadBill(){
 if(!currentOrder){
  bill.innerHTML='';
  total.innerText=0;
  return;
 }

 const { data } = await db.from('order_items')
  .select('*')
  .eq('order_id',currentOrder.id);

 let sum=0;
 bill.innerHTML='';
 data.forEach(i=>{
  bill.innerHTML+=`<div>${i.product_name} x ${i.qty}</div>`;
  sum+=i.price*i.qty;
 });
 total.innerText=sum;
}

/* ================= SEND KITCHEN ================= */
async function sendToKitchen(){
 if(!currentOrder) return;
 await db.from('order_items')
  .update({status:'sent'})
  .eq('order_id',currentOrder.id)
  .eq('status','draft');
 Swal.fire('‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß');
}

/* ================= PAYMENT ================= */
function checkout(type){
 if(!currentOrder) return;
 currentPayment=type;
 const sum=Number(total.innerText);

 if(type==='promptpay'){
  Swal.fire({
   title:'‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢',
   html:`<img src="https://promptpay.io/${PROMPTPAY_ID}/${sum}.png">`,
   confirmButtonText:'‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß'
  }).then(r=>{if(r.isConfirmed)confirmPay();});
 }else{
  Swal.fire({
   title:`‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ${sum} ‡∏ö‡∏≤‡∏ó`,
   confirmButtonText:'‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß'
  }).then(r=>{if(r.isConfirmed)confirmPay();});
 }
}

async function confirmPay(){
 await db.from('orders')
  .update({
   status:'paid',
   total:Number(total.innerText),
   payment:currentPayment
  })
  .eq('id',currentOrder.id);

 await db.from('tables')
  .update({status:'free'})
  .eq('id',tableSelect.value);

 currentOrder=null;
 currentPayment=null;
 loadBill();
 Swal.fire('‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
}
</script>

</body>
</html>
