<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{
  background:#020617;
  color:#e5e7eb;
}
button{ font-weight:600 }
</style>
</head>

<body class="p-3 space-y-3">

<h1 class="text-xl font-bold text-center">üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</h1>

<!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ -->
<select id="tableSelect" class="w-full p-2 text-black rounded"
 onchange="selectTable()">
  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>
</select>

<!-- ‡∏´‡∏°‡∏ß‡∏î -->
<div id="categoryBar" class="flex gap-2 overflow-x-auto"></div>

<!-- ‡πÄ‡∏°‡∏ô‡∏π -->
<div id="menu" class="grid grid-cols-2 gap-2"></div>

<!-- ‡∏ö‡∏¥‡∏• -->
<div class="bg-slate-800 p-3 rounded space-y-2">
  <div id="bill"></div>

  <div class="border-t border-slate-600 pt-2 font-bold text-lg">
    ‡∏£‡∏ß‡∏°: <span id="total">0</span> ‡∏ö‡∏≤‡∏ó
  </div>

  <!-- üî• ‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏ß -->
  <button onclick="sendToKitchen()"
   class="w-full bg-orange-500 py-2 rounded">
   üî• ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß
  </button>
</div>

<!-- ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
<div class="flex gap-2">
  <button onclick="checkout('cash')"
   class="flex-1 bg-emerald-600 py-3 rounded">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
  <button onclick="checkout('transfer')"
   class="flex-1 bg-indigo-600 py-3 rounded">üì≤ ‡πÇ‡∏≠‡∏ô</button>
</div>

<!-- ================= MODAL ‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô ================= -->
<div id="addonModal"
 class="fixed inset-0 bg-black/70 hidden items-center justify-center">
  <div class="bg-slate-800 p-4 rounded w-80 space-y-2">
    <h2 id="addonTitle" class="font-bold text-center"></h2>

    <label>
      <input type="checkbox" id="addonSpecial"> ‡∏û‡∏¥‡πÄ‡∏®‡∏© +10
    </label>

    <label>
      <input type="checkbox" id="addonMix" onchange="toggleMix()"> ‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥ +10
    </label>

    <select id="mixSelect"
     class="w-full text-black hidden"></select>

    <button onclick="confirmAddon()"
     class="bg-emerald-600 w-full py-2 rounded">
      ‡πÄ‡∏û‡∏¥‡πà‡∏°
    </button>

    <button onclick="closeAddon()"
     class="bg-slate-600 w-full py-1 rounded">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  </div>
</div>

<!-- ================= MODAL ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ================= -->
<div id="payModal"
 class="fixed inset-0 bg-black/70 hidden items-center justify-center">
  <div class="bg-slate-800 p-4 rounded w-80 space-y-2">
    <h2 id="payTitle" class="font-bold text-center"></h2>

    <div id="transferBox" class="hidden text-center">
      <img id="ppQR" class="mx-auto w-56 bg-white p-2 rounded">
      <button onclick="confirmPay()"
       class="bg-indigo-600 w-full py-2 rounded">
       ‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß
      </button>
    </div>

    <div id="cashBox" class="hidden space-y-1">
      <input id="cashInput" type="number"
       class="w-full p-2 text-black rounded"
       placeholder="‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô"
       oninput="calcChange()">
      ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: <span id="changeText">0</span>
      <button onclick="confirmPay()"
       class="bg-emerald-600 w-full py-2 rounded">
       ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß
      </button>
    </div>

    <button onclick="closePay()"
     class="bg-red-600 w-full py-1 rounded">
     ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss";
const PROMPTPAY_ID = "0869525072";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= STATE ================= */
let categories=[], products=[], tables=[];
let currentOrder=null;
let cartDraft=[];
let currentProduct=null;

/* ================= INIT ================= */
async function init(){
  categories = (await db.from('categories').select('*')).data;
  products   = (await db.from('products').select('*').eq('active',true)).data;
  tables     = (await db.from('tables').select('*')).data;

  renderTables();
  renderCategories();
}
init();

/* ================= TABLE ================= */
function renderTables(){
  tableSelect.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>';
  tables.forEach(t=>{
    tableSelect.innerHTML+=`
      <option value="${t.id}">
        ${t.name} (${t.status})
      </option>`;
  });
}

async function selectTable(){
  const tableId=tableSelect.value;
  if(!tableId) return;

  const { data:order } = await db
    .from('orders')
    .select('*')
    .eq('table_id',tableId)
    .eq('status','open')
    .maybeSingle();

  if(order){
    currentOrder=order;
    loadBill();
  }else{
    currentOrder=null;
    bill.innerHTML='';
    total.innerText=0;
  }
}

/* ================= CATEGORY ================= */
function renderCategories(){
  categoryBar.innerHTML='';
  categories.forEach(c=>{
    const b=document.createElement('button');
    b.className='bg-slate-700 px-4 py-2 rounded';
    b.innerText=c.name;
    b.onclick=()=>loadCategory(c.name);
    categoryBar.appendChild(b);
  });
}

function loadCategory(cat){
  menu.innerHTML='';
  products.filter(p=>p.category===cat)
  .forEach(p=>{
    const b=document.createElement('button');
    b.className='bg-slate-700 p-3 rounded';
    b.innerText=`${p.name}\n${p.price} ‡∏ö‡∏≤‡∏ó`;
    b.onclick=()=>addItem(p);
    menu.appendChild(b);
  });
}

/* ================= ADD ITEM ================= */
async function addItem(p){
  if(!currentOrder){
    const { data } = await db.from('orders')
      .insert({
        table_id: tableSelect.value,
        status:'open'
      })
      .select().single();

    currentOrder=data;
    await db.from('tables')
      .update({status:'busy'})
      .eq('id',tableSelect.value);
  }

  if(p.category==='‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô'){
    currentProduct=p;
    addonTitle.innerText=p.name;
    buildMixOptions(p.name);
    addonModal.classList.replace('hidden','flex');
    return;
  }

  await addDraftItem(p.name,p.price);
  loadBill();
}

async function addDraftItem(name,price){
  await db.from('order_items').insert({
    order_id: currentOrder.id,
    product_name:name,
    price,
    qty:1,
    status:'draft'
  });
}

/* ================= ADDON ================= */
function buildMixOptions(main){
  mixSelect.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡πâ‡∏≥ --</option>';
  products.filter(p=>p.category==='‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô'&&p.name!==main)
    .forEach(p=>mixSelect.innerHTML+=`<option>${p.name}</option>`);
}

function toggleMix(){
  mixSelect.classList.toggle('hidden',!addonMix.checked);
}

async function confirmAddon(){
  let name=currentProduct.name;
  let price=currentProduct.price;
  let opt=[];

  if(addonSpecial.checked){ price+=10; opt.push('‡∏û‡∏¥‡πÄ‡∏®‡∏©'); }
  if(addonMix.checked){
    if(!mixSelect.value){ alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡πâ‡∏≥'); return; }
    price+=10; opt.push(`‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥:${mixSelect.value}`);
  }

  if(opt.length) name+=` (${opt.join(',')})`;
  await addDraftItem(name,price);
  closeAddon();
  loadBill();
}

function closeAddon(){
  addonModal.classList.replace('flex','hidden');
  addonSpecial.checked=false;
  addonMix.checked=false;
  mixSelect.classList.add('hidden');
}

/* ================= BILL ================= */
async function loadBill(){
  const { data } = await db.from('order_items')
    .select('*')
    .eq('order_id',currentOrder.id);

  bill.innerHTML='';
  let sum=0;
  data.forEach(i=>{
    bill.innerHTML+=`<div>${i.product_name} x ${i.qty}</div>`;
    sum+=i.price*i.qty;
  });
  total.innerText=sum;
}

/* ================= SEND KITCHEN ================= */
async function sendToKitchen(){
  if(!currentOrder) return;

  await db.from('order_items')
    .update({status:'sent'})
    .eq('order_id',currentOrder.id)
    .eq('status','draft');

  Swal.fire('‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß');
}

/* ================= PAYMENT ================= */
function checkout(type){
  if(!currentOrder) return;
  const sum=Number(total.innerText);
  payModal.classList.replace('hidden','flex');

  transferBox.classList.add('hidden');
  cashBox.classList.add('hidden');

  if(type==='transfer'){
    payTitle.innerText=`‡πÇ‡∏≠‡∏ô ${sum} ‡∏ö‡∏≤‡∏ó`;
    transferBox.classList.remove('hidden');
    ppQR.src=`https://promptpay.io/${PROMPTPAY_ID}/${sum}.png`;
  }else{
    payTitle.innerText=`‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ${sum} ‡∏ö‡∏≤‡∏ó`;
    cashBox.classList.remove('hidden');
  }
}

async function confirmPay(){
  await db.from('orders')
    .update({status:'paid', total:Number(total.innerText)})
    .eq('id',currentOrder.id);

  await db.from('tables')
    .update({status:'free'})
    .eq('id',tableSelect.value);

  currentOrder=null;
  bill.innerHTML='';
  total.innerText=0;
  payModal.classList.replace('flex','hidden');
  Swal.fire('‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
}

function closePay(){
  payModal.classList.replace('flex','hidden');
}
</script>

</body>
</html>
