<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white p-3">

<h1 class="text-xl font-bold text-center mb-3">üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</h1>

<!-- ‡∏´‡∏°‡∏ß‡∏î -->
<div class="flex gap-2 mb-3">
  <button onclick="loadCategory('‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô')" class="flex-1 bg-orange-600 py-2 rounded">üçú ‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</button>
  <button onclick="loadCategory('‡∏ô‡πâ‡∏≥')" class="flex-1 bg-sky-600 py-2 rounded">üßä ‡∏ô‡πâ‡∏≥</button>
  <button onclick="loadCategory('‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô')" class="flex-1 bg-green-600 py-2 rounded">üçó ‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô</button>
</div>

<!-- ‡πÄ‡∏°‡∏ô‡∏π -->
<div id="menu" class="grid grid-cols-2 gap-2 mb-3"></div>

<!-- ‡∏ö‡∏¥‡∏• -->
<div class="bg-slate-800 p-3 rounded mb-3">
  <div id="bill"></div>
  <div class="border-t border-slate-600 mt-2 pt-2 text-lg font-bold">
    ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="total">0</span> ‡∏ö‡∏≤‡∏ó
  </div>
</div>

<!-- ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
<div class="flex gap-2">
  <button onclick="checkout('cash')" class="flex-1 bg-emerald-600 py-3 rounded text-lg">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
  <button onclick="checkout('transfer')" class="flex-1 bg-indigo-600 py-3 rounded text-lg">üì≤ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
</div>

<button onclick="cancelOrder()" class="w-full mt-2 bg-red-600 py-2 rounded text-lg">
  ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
</button>

<!-- ================= MODAL ‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô ================= -->
<div id="addonModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center">
  <div class="bg-slate-800 p-4 rounded w-80">
    <h2 id="addonTitle" class="text-lg font-bold mb-2 text-center"></h2>

    <label class="block">
      <input type="checkbox" id="addonSpecial"> ‡∏û‡∏¥‡πÄ‡∏®‡∏© +10
    </label>

    <label class="block mt-1">
      <input type="checkbox" id="addonMix" onchange="toggleMix()"> ‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥ +10
    </label>

    <select id="mixSelect" class="w-full text-black mt-1 hidden"></select>

    <label class="block mt-1">
      <input type="checkbox" id="addonEgg"> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏° +10
    </label>

    <button onclick="confirmAddon()" class="mt-3 bg-emerald-600 w-full py-2 rounded">
      ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ö‡∏¥‡∏•
    </button>

    <button onclick="closeAddon()" class="mt-2 bg-slate-600 w-full py-1 rounded">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  </div>
</div>

<!-- ================= MODAL ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ================= -->
<div id="payModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center">
  <div class="bg-slate-800 p-4 rounded w-80">
    <h2 id="payTitle" class="text-lg font-bold mb-3 text-center"></h2>

    <!-- ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô -->
    <div id="transferBox" class="hidden text-center">
      <img id="ppQR" class="mx-auto mb-3 w-56">
      <button onclick="confirmPay('transfer')" class="bg-indigo-600 w-full py-2 rounded">
        ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô
      </button>
    </div>

    <!-- ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î -->
    <div id="cashBox" class="hidden">
      <label>‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</label>
      <input id="cashInput" type="number"
        class="w-full p-2 text-black rounded mb-2"
        oninput="calcChange()">
      <div>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: <span id="changeText">0</span> ‡∏ö‡∏≤‡∏ó</div>
      <button onclick="confirmPay('cash')" class="mt-2 bg-emerald-600 w-full py-2 rounded">
        ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
      </button>
    </div>

    <button onclick="closePay()" class="mt-3 bg-red-600 w-full py-1 rounded">
      ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss";
const PROMPTPAY_ID = "0936494961";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= STATE ================= */
let products = [];      // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà active = true ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
let cart = [];
let currentProduct = null;

/* ================= LOAD PRODUCTS ================= */
async function loadProducts() {
  const { data, error } = await db
    .from('products')
    .select('*')
    .eq('active', true);

  if (error) {
    alert('‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    console.error(error);
    return;
  }

  products = data;
  loadCategory('‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô');
}

/* ================= CATEGORY ================= */
function loadCategory(cat) {
  menu.innerHTML = '';
  products
    .filter(p => p.category === cat)
    .forEach(p => {
      const btn = document.createElement('button');
      btn.className = 'bg-slate-700 p-4 rounded';
      btn.innerText = `${p.name}\n${p.price} ‡∏ö‡∏≤‡∏ó`;
      btn.onclick = () => addItem(p);
      menu.appendChild(btn);
    });
}

/* ================= ADD ITEM ================= */
function addItem(p) {
  if (p.category === '‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô') {
    currentProduct = p;
    addonTitle.innerText = `${p.name} (${p.price} ‡∏ö‡∏≤‡∏ó)`;
    buildMixOptions(p.name);
    addonModal.classList.remove('hidden');
    addonModal.classList.add('flex');
    return;
  }

  cart.push({ name: p.name, price: p.price });
  renderBill();
}

/* ================= MIX OPTIONS (FROM DB) ================= */
function buildMixOptions(mainName) {
  mixSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏ú‡∏™‡∏° --</option>';

  products
    .filter(p =>
      p.category === '‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô' &&   // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡πâ‡∏≥‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô
      p.active === true &&          // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢
      p.name !== mainName           // ‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏´‡∏•‡∏±‡∏Å
    )
    .forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.name;
      opt.textContent = p.name;
      mixSelect.appendChild(opt);
    });
}

function toggleMix() {
  mixSelect.classList.toggle('hidden', !addonMix.checked);
}

/* ================= CONFIRM ADDON ================= */
function confirmAddon() {
  let name = currentProduct.name;
  let price = currentProduct.price;
  let detail = [];

  if (addonSpecial.checked) {
    price += 10;
    detail.push('‡∏û‡∏¥‡πÄ‡∏®‡∏©');
  }

  if (addonMix.checked) {
    if (!mixSelect.value) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ú‡∏™‡∏°');
      return;
    }
    price += 10;
    detail.push(`‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥: ${mixSelect.value}`);
  }

  if (addonEgg.checked) {
    price += 10;
    detail.push('‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏°');
  }

  if (detail.length) {
    name += ` (${detail.join(', ')})`;
  }

  cart.push({ name, price });
  closeAddon();
  renderBill();
}

function closeAddon() {
  addonModal.classList.add('hidden');
  addonSpecial.checked = false;
  addonMix.checked = false;
  addonEgg.checked = false;
  mixSelect.classList.add('hidden');
  mixSelect.value = '';
}

/* ================= BILL ================= */
function renderBill() {
  bill.innerHTML = '';
  let sum = 0;

  cart.forEach(i => {
    bill.innerHTML += `<div>${i.name} = ${i.price}</div>`;
    sum += i.price;
  });

  total.innerText = sum;
}

/* ================= PAYMENT ================= */
function checkout(type) {
  if (!cart.length) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

  const sum = cart.reduce((s,i)=>s+i.price,0);
  payModal.classList.remove('hidden');
  payModal.classList.add('flex');

  cashBox.classList.add('hidden');
  transferBox.classList.add('hidden');

  if (type === 'transfer') {
    payTitle.innerText = `‡πÇ‡∏≠‡∏ô ${sum} ‡∏ö‡∏≤‡∏ó`;
    transferBox.classList.remove('hidden');
    ppQR.src = `https://promptpay.io/${PROMPTPAY_ID}/${sum.toFixed(2)}.png`;
  } else {
    payTitle.innerText = `‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ${sum} ‡∏ö‡∏≤‡∏ó`;
    cashBox.classList.remove('hidden');
    cashInput.value = '';
    changeText.innerText = '0';
  }
}

function calcChange() {
  const sum = cart.reduce((s,i)=>s+i.price,0);
  changeText.innerText = cashInput.value - sum;
}

async function confirmPay(type) {
  const sum = cart.reduce((s,i)=>s+i.price,0);

  if (type === 'cash' && Number(cashInput.value) < sum) {
    alert('‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠');
    return;
  }

  const { data: order, error } = await db
    .from('orders')
    .insert({ total: sum, payment: type })
    .select()
    .single();

  if (error) {
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    console.error(error);
    return;
  }

  for (const i of cart) {
    await db.from('order_items').insert({
      order_id: order.id,
      product_name: i.name,
      qty: 1,
      price: i.price
    });
  }

  cart = [];
  renderBill();
  closePay();
  alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
}

function closePay() {
  payModal.classList.add('hidden');
}

/* ================= CANCEL ================= */
function cancelOrder() {
  if (!cart.length) return;
  if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

  cart = [];
  renderBill();
  closePay();
}

/* ================= START ================= */
loadProducts();
</script>

</body>
</html>
