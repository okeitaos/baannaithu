<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-slate-900 text-white p-3 space-y-3">

<h1 class="text-xl font-bold text-center">üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</h1>

<!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ -->
<select id="tableSelect" class="w-full p-2 text-black rounded">
  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>
</select>

<!-- ‡πÄ‡∏°‡∏ô‡∏π -->
<div id="menu" class="grid grid-cols-2 gap-2"></div>

<!-- ‡∏ö‡∏¥‡∏• -->
<div class="bg-slate-800 p-3 rounded">
  <div id="bill"></div>
  <div class="border-t border-slate-600 mt-2 pt-2 text-lg font-bold">
    ‡∏£‡∏ß‡∏°: <span id="total">0</span> ‡∏ö‡∏≤‡∏ó
  </div>
</div>

<!-- ‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏ß -->
<button onclick="sendToKitchen()"
  class="w-full bg-emerald-600 py-3 rounded font-bold">
  üç≥ ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß
</button>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= STATE ================= */
let products = [];
let tables = [];
let cart = [];

/* ================= INIT ================= */
async function init(){

  /* ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π */
  const { data:productData, error:productErr } =
    await db.from('products')
      .select('*')
      .eq('active', true);

  if(productErr){
    console.error(productErr);
    Swal.fire('‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return;
  }

  products = productData || [];

  /* ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ï‡πä‡∏∞ (‡πÅ‡∏Å‡πâ boolean ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á) */
  const { data } = await db
  .from('tables')
  .select('*');


  if(tableErr){
    console.error(tableErr);
    Swal.fire('‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ï‡πä‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return;
  }

  tables = tableData || [];

  /* ‡πÄ‡∏ï‡∏¥‡∏° select ‡πÇ‡∏ï‡πä‡∏∞ */
  tableSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>';
  tables.forEach(t=>{
    tableSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
  });

  renderMenu();
}

/* ================= MENU ================= */
function renderMenu(){
  menu.innerHTML = '';
  products.forEach(p=>{
    const btn = document.createElement('button');
    btn.className = 'bg-slate-700 p-3 rounded';
    btn.innerText = `${p.name}\n${p.price} ‡∏ö‡∏≤‡∏ó`;
    btn.onclick = ()=>addItem(p);
    menu.appendChild(btn);
  });
}

function addItem(p){
  const found = cart.find(i=>i.name===p.name);
  if(found){
    found.qty++;
  }else{
    cart.push({
      name:p.name,
      price:p.price,
      qty:1
    });
  }
  renderBill();
}

/* ================= BILL ================= */
function renderBill(){
  bill.innerHTML='';
  let sum = 0;

  cart.forEach((i,idx)=>{
    sum += i.price * i.qty;
    bill.innerHTML += `
      <div class="flex justify-between text-sm">
        <span>${i.name} √ó ${i.qty}</span>
        <span>${i.price * i.qty}</span>
      </div>
    `;
  });

  total.innerText = sum;
}

/* ================= SEND TO KITCHEN ================= */
async function sendToKitchen(){

  if(!tableSelect.value){
    Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞');
    return;
  }
  if(!cart.length){
    Swal.fire('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    return;
  }

  /* 1Ô∏è‚É£ ‡∏™‡∏£‡πâ‡∏≤‡∏á order */
  const { data:order, error:orderErr } =
    await db.from('orders')
      .insert({
        table_id: tableSelect.value,
        status: 'open'
      })
      .select()
      .single();

  if(orderErr){
    console.error(orderErr);
    Swal.fire('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return;
  }

  /* 2Ô∏è‚É£ ‡πÄ‡∏û‡∏¥‡πà‡∏° order_items */
  for(const i of cart){
    const { error:itemErr } =
      await db.from('order_items').insert({
        order_id: order.id,
        product_name: i.name,
        price: i.price,
        qty: i.qty
      });

    if(itemErr){
      console.error(itemErr);
      Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      return;
    }
  }

  /* 3Ô∏è‚É£ üî• ‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ß realtime */
  await db.channel('notify-kitchen').send({
    type:'broadcast',
    event:'new_order',
    payload:{ order_id: order.id }
  });

  /* 4Ô∏è‚É£ reset ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
  cart = [];
  renderBill();

  Swal.fire({
    icon:'success',
    title:'‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß'
  });
}

/* ================= START ================= */
init();
</script>

</body>
</html>
