<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{background:#020617;color:#e5e7eb}
button{font-weight:600}
</style>
</head>

<body class="p-3 space-y-3">

<h1 class="text-xl font-bold text-center">üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</h1>

<!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ -->
<select id="tableSelect" class="w-full p-2 text-black rounded"
  onchange="openTable()">
  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>
</select>

<!-- ‡∏´‡∏°‡∏ß‡∏î -->
<div id="categoryBar" class="flex gap-2 overflow-x-auto"></div>

<!-- ‡πÄ‡∏°‡∏ô‡∏π -->
<div id="menu" class="grid grid-cols-2 gap-2"></div>

<!-- ‡∏ö‡∏¥‡∏• -->
<div class="bg-slate-800 p-3 rounded">
  <div id="bill"></div>
  <div class="border-t mt-2 pt-2 text-lg font-bold">
    ‡∏£‡∏ß‡∏°: <span id="total">0</span> ‡∏ö‡∏≤‡∏ó
  </div>
</div>

<!-- ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
<div class="flex gap-2">
  <button onclick="pay('cash')" class="flex-1 bg-emerald-600 py-3 rounded">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
  <button onclick="pay('promptpay')" class="flex-1 bg-indigo-600 py-3 rounded">üì≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</button>
</div>

<script>
/* ================= CONFIG ================= */
const db = supabase.createClient(
  "https://nvsptbbvxjulrpdebrhn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
);

/* ================= STATE ================= */
let tables=[], categories=[], products=[];
let currentOrder = null;

/* ================= INIT ================= */
async function init(){
  tables     = (await db.from('tables').select('*')).data || [];
  categories = (await db.from('categories').select('*')).data || [];
  products   = (await db.from('products').select('*').eq('active',true)).data || [];

  loadTables();
  renderCategories();
}
init();

/* ================= TABLE ================= */
function loadTables(){
  tableSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>';
  tables.forEach(t=>{
    tableSelect.innerHTML +=
      `<option value="${t.id}">
        ${t.name} (${t.status})
      </option>`;
  });
}

async function openTable(){
  const tableId = tableSelect.value;
  if(!tableId) return;

  const { data:orders } = await db
    .from('orders')
    .select('*')
    .eq('table_id', tableId)
    .eq('status','open')
    .limit(1);

  if(orders.length){
    currentOrder = orders[0];
    loadBill();
  }else{
    const { data:newOrder } = await db
      .from('orders')
      .insert({ table_id:tableId, status:'open' })
      .select().single();

    currentOrder = newOrder;
    await db.from('tables')
      .update({ status:'in_use' })
      .eq('id', tableId);

    loadTables();
    loadBill();
  }
}

/* ================= CATEGORY ================= */
function renderCategories(){
  categoryBar.innerHTML='';
  categories.forEach(c=>{
    const b=document.createElement('button');
    b.className='bg-slate-700 px-4 py-2 rounded';
    b.innerText=c.name;
    b.onclick=()=>loadMenu(c.name);
    categoryBar.appendChild(b);
  });
}

function loadMenu(cat){
  menu.innerHTML='';
  products.filter(p=>p.category===cat).forEach(p=>{
    const b=document.createElement('button');
    b.className='bg-slate-700 p-3 rounded';
    b.innerText=`${p.name}\n${p.price} ‡∏ö‡∏≤‡∏ó`;
    b.onclick=()=>orderFood(p);
    menu.appendChild(b);
  });
}

/* ================= ORDER ================= */
async function orderFood(p){
  if(!currentOrder){
    Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡πà‡∏≠‡∏ô');
    return;
  }

  await db.from('order_items').insert({
    order_id: currentOrder.id,
    product_name: p.name,
    price: p.price,
    qty: 1
  });

  loadBill();
}

/* ================= BILL ================= */
async function loadBill(){
  const { data:items } = await db
    .from('order_items')
    .select('*')
    .eq('order_id', currentOrder.id);

  bill.innerHTML='';
  let sum=0;

  items.forEach(i=>{
    sum+=i.price*i.qty;
    bill.innerHTML+=`
      <div class="flex justify-between border-b py-1">
        <span>${i.product_name} x ${i.qty}</span>
        <span>${i.price*i.qty}</span>
      </div>`;
  });

  total.innerText=sum;
}

/* ================= PAYMENT ================= */
async function pay(type){
  if(!currentOrder) return;

  const sum=Number(total.innerText);

  const ok = await Swal.fire({
    title:`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ${sum} ‡∏ö‡∏≤‡∏ó`,
    showCancelButton:true
  });
  if(!ok.isConfirmed) return;

  await db.from('orders').update({
    status:'paid',
    payment:type,
    total:sum
  }).eq('id', currentOrder.id);

  await db.from('tables')
    .update({ status:'available' })
    .eq('id', currentOrder.table_id);

  currentOrder=null;
  bill.innerHTML='';
  total.innerText=0;
  loadTables();

  Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß','success');
}
</script>

</body>
</html>
