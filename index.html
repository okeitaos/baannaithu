<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-slate-900 text-white p-3 space-y-3">

<h1 class="text-xl font-bold text-center">üçú POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏°‡∏à‡∏µ‡∏ô</h1>

<select id="tableSelect" class="w-full p-2 text-black rounded">
  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ --</option>
</select>

<div id="menu" class="grid grid-cols-2 gap-2"></div>

<div class="bg-slate-800 p-3 rounded">
  <div id="bill"></div>
  <div class="border-t mt-2 pt-2 font-bold">
    ‡∏£‡∏ß‡∏°: <span id="total">0</span> ‡∏ö‡∏≤‡∏ó
  </div>
</div>

<button onclick="sendToKitchen()"
  class="w-full bg-emerald-600 py-3 rounded font-bold">
  üç≥ ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß
</button>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= STATE ================= */
let products = [];
let tables = [];
let cart = [];

/* ================= INIT ================= */
async function init(){
  products = (await db.from('products').select('*').eq('active',true)).data || [];
  tables = (await db.from('tables').select('*').eq('active',true)).data || [];

  tables.forEach(t=>{
    tableSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
  });

  renderMenu();
}

/* ================= MENU ================= */
function renderMenu(){
  menu.innerHTML = '';
  products.forEach(p=>{
    const b = document.createElement('button');
    b.className = 'bg-slate-700 p-3 rounded';
    b.innerText = `${p.name}\n${p.price} ‡∏ö‡∏≤‡∏ó`;
    b.onclick = ()=>addItem(p);
    menu.appendChild(b);
  });
}

function addItem(p){
  const found = cart.find(i=>i.name===p.name);
  if(found){
    found.qty++;
  }else{
    cart.push({ name:p.name, price:p.price, qty:1 });
  }
  renderBill();
}

function renderBill(){
  bill.innerHTML='';
  let sum=0;
  cart.forEach((i,idx)=>{
    sum+=i.price*i.qty;
    bill.innerHTML+=`
      <div class="flex justify-between text-sm">
        <span>${i.name} x${i.qty}</span>
        <span>${i.price*i.qty}</span>
      </div>
    `;
  });
  total.innerText=sum;
}

/* ================= SEND TO KITCHEN ================= */
async function sendToKitchen(){
  if(!cart.length){
    Swal.fire('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    return;
  }
  if(!tableSelect.value){
    Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞');
    return;
  }

  // 1Ô∏è‚É£ create order
  const { data:order } = await db.from('orders')
    .insert({
      table_id: tableSelect.value,
      status:'open'
    })
    .select()
    .single();

  // 2Ô∏è‚É£ create order items
  for(const i of cart){
    await db.from('order_items').insert({
      order_id: order.id,
      product_name: i.name,
      price: i.price,
      qty: i.qty
    });
  }

  // 3Ô∏è‚É£ üî• broadcast ‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ß
  await db.channel('notify-kitchen').send({
    type:'broadcast',
    event:'new_order',
    payload:{ order_id: order.id }
  });

  // 4Ô∏è‚É£ reset ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞)
  cart = [];
  renderBill();

  Swal.fire({
    icon:'success',
    title:'‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß'
  });
}

init();
</script>

</body>
</html>
