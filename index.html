<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>üçú POS ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen">

<div class="max-w-7xl mx-auto p-4 grid grid-cols-12 gap-4">

  <!-- ===== ‡πÇ‡∏ï‡πä‡∏∞ ===== -->
  <div class="col-span-3 bg-slate-800 rounded-xl p-4">
    <h2 class="text-xl font-bold mb-3">ü™ë ‡πÇ‡∏ï‡πä‡∏∞‡∏ß‡πà‡∏≤‡∏á</h2>
    <div id="tableList" class="grid grid-cols-2 gap-2"></div>
  </div>

  <!-- ===== ‡πÄ‡∏°‡∏ô‡∏π ===== -->
  <div class="col-span-5 bg-slate-800 rounded-xl p-4">
    <h2 class="text-xl font-bold mb-3">üìã ‡πÄ‡∏°‡∏ô‡∏π</h2>
    <div id="menuList" class="space-y-2"></div>
  </div>

  <!-- ===== ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå / ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô ===== -->
  <div class="col-span-4 bg-slate-800 rounded-xl p-4">
    <h2 class="text-xl font-bold mb-3">
      üßæ ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå ‡πÇ‡∏ï‡πä‡∏∞ <span id="currentTable">-</span>
    </h2>

    <div id="orderItems" class="space-y-2 mb-4"></div>

    <div class="border-t border-slate-600 pt-3">
      <div class="flex justify-between text-lg font-bold">
        <span>‡∏£‡∏ß‡∏°</span>
        <span id="totalPrice">0 ‡∏ø</span>
      </div>

      <button onclick="payOrder()"
        class="w-full mt-4 bg-green-600 hover:bg-green-700 py-2 rounded-lg font-bold">
        üí∞ ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô
      </button>
    </div>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const sb = supabase.createClient(
  "https://nvsptbbvxjulrpdebrhn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
)

let currentOrderId = null
let currentTableId = null
let currentTableNo = null

/* ================= LOAD TABLES ================= */
async function loadTables() {
  const { data } = await sb
    .from("tables")
    .select("*")
    .eq("status", "available")
    .order("table_no")

  tableList.innerHTML = ""
  data.forEach(t => {
    const btn = document.createElement("button")
    btn.className = "bg-green-600 hover:bg-green-700 p-3 rounded-lg font-bold"
    btn.textContent = "‡πÇ‡∏ï‡πä‡∏∞ " + t.table_no
    btn.onclick = () => openTable(t)
    tableList.appendChild(btn)
  })
}

/* ================= OPEN TABLE ================= */
async function openTable(table) {
  const { data: order, error } = await sb
    .from("orders")
    .insert({
      table_id: table.id,
      status: "open",
      total_price: 0
    })
    .select()
    .single()

  if (error) {
    alert("‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏ï‡πä‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
    return
  }

  await sb.from("tables")
    .update({
      status: "occupied",
      current_order_id: order.id
    })
    .eq("id", table.id)

  currentOrderId = order.id
  currentTableId = table.id
  currentTableNo = table.table_no
  currentTable.textContent = table.table_no

  loadOrderItems()
  loadTables()
}

/* ================= LOAD MENU ================= */
async function loadMenu() {
  const { data } = await sb
    .from("products")
    .select("*")
    .eq("active", true)
    .order("name")

  menuList.innerHTML = ""

  data.forEach(p => {
    const div = document.createElement("div")
    div.className = "bg-slate-700 p-3 rounded-lg"

    div.innerHTML = `
      <div class="font-bold">${p.name} - ${p.price}‡∏ø</div>
      <div class="flex items-center gap-2 mt-2 text-sm">
        <label><input type="checkbox" id="sp_${p.id}"> ‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>
        <label><input type="checkbox" id="mix_${p.id}"> ‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥</label>
        <button
          class="ml-auto bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded"
          onclick="addItem('${p.id}', ${p.price})">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      </div>
    `
    menuList.appendChild(div)
  })
}

/* ================= ADD ITEM ================= */
async function addItem(productId, price) {
  if (!currentOrderId) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡πà‡∏≠‡∏ô")
    return
  }

  const special = document.getElementById("sp_" + productId)?.checked || false
  const mix = document.getElementById("mix_" + productId)?.checked || false

  await sb.from("order_items").insert({
    order_id: currentOrderId,
    product_id: productId,
    qty: 1,
    price,
    option_special: special,
    option_mix: mix,
    status: "pending"
  })

  document.getElementById("sp_" + productId).checked = false
  document.getElementById("mix_" + productId).checked = false
}

/* ================= LOAD ORDER ITEMS ================= */
async function loadOrderItems() {
  if (!currentOrderId) return

  const { data } = await sb
    .from("order_items")
    .select("id, qty, price, option_special, option_mix, products(name)")
    .eq("order_id", currentOrderId)

  let total = 0
  orderItems.innerHTML = ""

  data.forEach(i => {
    total += i.price * i.qty
    const div = document.createElement("div")
    div.className = "bg-slate-700 p-2 rounded text-sm"
    div.textContent =
      `${i.products.name}` +
      (i.option_special ? " (‡∏û‡∏¥‡πÄ‡∏®‡∏©)" : "") +
      (i.option_mix ? " (‡∏ú‡∏™‡∏°‡∏ô‡πâ‡∏≥)" : "")
    orderItems.appendChild(div)
  })

  totalPrice.textContent = total + " ‡∏ø"

  await sb.from("orders")
    .update({ total_price: total })
    .eq("id", currentOrderId)
}

/* ================= PAY ================= */
async function payOrder() {
  if (!currentOrderId) return

  if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡πÇ‡∏ï‡πä‡∏∞ ${currentTableNo}?`)) return

  await sb.from("orders")
    .update({ status: "paid" })
    .eq("id", currentOrderId)

  await sb.from("tables")
    .update({
      status: "available",
      current_order_id: null
    })
    .eq("id", currentTableId)

  alert("‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")

  currentOrderId = null
  currentTableId = null
  currentTableNo = null
  currentTable.textContent = "-"
  orderItems.innerHTML = ""
  totalPrice.textContent = "0 ‡∏ø"

  loadTables()
}

/* ================= REALTIME ================= */
sb.channel("pos-realtime")
  .on("postgres_changes",
    { event: "*", schema: "public", table: "order_items" },
    () => loadOrderItems()
  )
  .on("postgres_changes",
    { event: "*", schema: "public", table: "tables" },
    () => loadTables()
  )
  .subscribe()

/* ================= INIT ================= */
loadTables()
loadMenu()
</script>

</body>
</html>
