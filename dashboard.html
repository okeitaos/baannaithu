<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>üìä Dashboard (Owner Mode)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen p-3">

<div class="max-w-7xl mx-auto space-y-4">

  <!-- HEADER -->
  <h1 class="text-2xl font-bold">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡πâ‡∏≤‡∏ô (Owner Mode)</h1>

  <!-- KPI -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
    <div class="bg-slate-800 p-4 rounded">
      <div class="text-sm text-gray-400">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div id="thisMonth" class="text-2xl font-bold">0 ‡∏ø</div>
      <div id="compareText" class="text-sm mt-1"></div>
    </div>

    <div class="bg-slate-800 p-4 rounded">
      <div class="text-sm text-gray-400">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</div>
      <div id="lastMonth" class="text-2xl font-bold">0 ‡∏ø</div>
      <div class="text-sm text-gray-500">‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</div>
    </div>

    <div class="bg-slate-800 p-4 rounded">
      <div class="text-sm text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div>
      <div id="orderCount" class="text-2xl font-bold">0</div>
      <div class="text-sm text-gray-500">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß</div>
    </div>
  </div>

  <!-- COMPARE CHART -->
  <div class="bg-slate-800 p-4 rounded">
    <h2 class="font-bold mb-2">üìà ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ vs ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô)</h2>
    <canvas id="compareChart"></canvas>
  </div>

  <!-- TOP SELLER -->
  <div class="bg-slate-800 p-4 rounded">
    <h2 class="font-bold mb-2">üî• ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h2>
    <div id="topSeller" class="space-y-1 text-sm"></div>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const sb = supabase.createClient(
  "https://nvsptbbvxjulrpdebrhn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
)

/* ================= ELEMENT ================= */
const thisMonthEl = document.getElementById("thisMonth")
const lastMonthEl = document.getElementById("lastMonth")
const compareTextEl = document.getElementById("compareText")
const orderCountEl = document.getElementById("orderCount")
const topSellerEl = document.getElementById("topSeller")
const compareCanvas = document.getElementById("compareChart")

let compareChart

/* ================= UTILS ================= */
function thaiDate(iso) {
  const d = new Date(iso)
  d.setHours(d.getHours() + 7)
  return d.toISOString().slice(0,7)
}

/* ================= LOAD ================= */
async function loadDashboard() {
  const { data } = await sb
    .from("order_items")
    .select(`qty, price, product_id, orders!inner(paid_at)`)
    .eq("status", "done")

  const rows = data || []

  const now = new Date()
  const thisMonth = thaiDate(now.toISOString())
  now.setMonth(now.getMonth() - 1)
  const lastMonth = thaiDate(now.toISOString())

  let sumThis = 0
  let sumLast = 0
  let count = rows.length
  const productQty = {}

  rows.forEach(r => {
    const m = thaiDate(r.orders.paid_at)
    const total = r.qty * r.price

    if (m === thisMonth) sumThis += total
    if (m === lastMonth) sumLast += total

    if (m === thisMonth) {
      productQty[r.product_id] =
        (productQty[r.product_id] || 0) + r.qty
    }
  })

  thisMonthEl.textContent = sumThis.toLocaleString() + " ‡∏ø"
  lastMonthEl.textContent = sumLast.toLocaleString() + " ‡∏ø"
  orderCountEl.textContent = count

  const diff = sumLast === 0 ? 0 : ((sumThis - sumLast) / sumLast * 100)
  compareTextEl.innerHTML =
    diff >= 0
      ? `<span class="text-green-400">‚ñ≤ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ${diff.toFixed(1)}%</span>`
      : `<span class="text-red-400">‚ñº ‡∏•‡∏î‡∏•‡∏á ${Math.abs(diff).toFixed(1)}%</span>`

  renderCompareChart(sumThis, sumLast)
  renderTopSeller(productQty)
}

/* ================= CHART ================= */
function renderCompareChart(thisM, lastM) {
  if (compareChart) compareChart.destroy()
  compareChart = new Chart(compareCanvas, {
    type: "bar",
    data: {
      labels: ["‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô", "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ"],
      datasets: [{
        label: "‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢",
        data: [lastM, thisM],
        backgroundColor: ["#64748b", "#22c55e"]
      }]
    }
  })
}

/* ================= TOP SELLER ================= */
function renderTopSeller(map) {
  topSellerEl.innerHTML = ""
  Object.entries(map)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,5)
    .forEach(([id,qty],i)=>{
      const div = document.createElement("div")
      div.textContent = `${i+1}. ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ #${id} ‚Äî ${qty} ‡∏ó‡∏µ‡πà`
      topSellerEl.appendChild(div)
    })
}

/* ================= INIT ================= */
loadDashboard()
</script>

</body>
</html>
