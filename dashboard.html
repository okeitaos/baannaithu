<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>üìä Dashboard ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen p-4">

<div class="max-w-7xl mx-auto space-y-4">

  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold">üìä Dashboard ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h1>
    <button onclick="exportExcel()"
      class="bg-green-600 px-4 py-2 rounded font-bold">
      üì• Export Excel
    </button>
  </div>

  <!-- SUMMARY -->
  <div class="grid md:grid-cols-3 gap-4">
    <div class="bg-slate-800 p-4 rounded">
      <div class="text-sm text-gray-400">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div id="todayTotal" class="text-2xl font-bold">0 ‡∏ø</div>
    </div>
    <div class="bg-slate-800 p-4 rounded">
      <div class="text-sm text-gray-400">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div id="monthTotal" class="text-2xl font-bold">0 ‡∏ø</div>
    </div>
    <div class="bg-slate-800 p-4 rounded">
      <div class="text-sm text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div>
      <div id="orderCount" class="text-2xl font-bold">0</div>
    </div>
  </div>

  <!-- CHART -->
  <div class="grid md:grid-cols-2 gap-4">
    <div class="bg-slate-800 p-4 rounded">
      <h2 class="font-bold mb-2">üìà ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>
      <canvas id="dailyChart"></canvas>
    </div>
    <div class="bg-slate-800 p-4 rounded">
      <h2 class="font-bold mb-2">üçú ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡πÄ‡∏°‡∏ô‡∏π</h2>
      <canvas id="productChart"></canvas>
    </div>
  </div>

  <!-- TABLE -->
  <div class="bg-slate-800 p-4 rounded">
    <h2 class="font-bold mb-3">üìÑ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
    <div class="overflow-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-slate-600">
            <th class="text-left p-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th class="text-left p-2">‡πÄ‡∏°‡∏ô‡∏π</th>
            <th class="text-right p-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            <th class="text-right p-2">‡∏¢‡∏≠‡∏î</th>
          </tr>
        </thead>
        <tbody id="saleTable"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const sb = supabase.createClient(
  "https://nvsptbbvxjulrpdebrhn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
)

/* ================= ELEMENT ================= */
const todayTotalEl = document.getElementById("todayTotal")
const monthTotalEl = document.getElementById("monthTotal")
const orderCountEl = document.getElementById("orderCount")
const saleTable = document.getElementById("saleTable")
const dailyCanvas = document.getElementById("dailyChart")
const productCanvas = document.getElementById("productChart")

/* ================= STATE ================= */
let saleRows = []
let productMap = {}
let dailyChart = null
let productChart = null

/* ================= UTILS ================= */
function thaiDate(iso) {
  const d = new Date(iso)
  d.setHours(d.getHours() + 7)
  return d.toISOString().slice(0, 10)
}

/* ================= LOAD ================= */
async function loadProducts() {
  const { data } = await sb.from("products").select("id,name")
  ;(data || []).forEach(p => productMap[p.id] = p.name)
}

async function loadSales() {
  const { data } = await sb
    .from("order_items")
    .select(`
      product_id,
      qty,
      price,
      orders!inner(paid_at)
    `)
    .eq("status", "done")

  saleRows = data || []
  renderDashboard()
}

/* ================= RENDER ================= */
function renderDashboard() {
  const today = thaiDate(new Date().toISOString())
  const month = today.slice(0, 7)

  let todaySum = 0
  let monthSum = 0
  const dailyMap = {}
  const productSum = {}

  saleRows.forEach(r => {
    const d = thaiDate(r.orders.paid_at)
    const total = r.qty * r.price

    if (d === today) todaySum += total
    if (d.startsWith(month)) monthSum += total

    dailyMap[d] = (dailyMap[d] || 0) + total
    productSum[r.product_id] =
      (productSum[r.product_id] || 0) + total
  })

  todayTotalEl.textContent = todaySum.toLocaleString() + " ‡∏ø"
  monthTotalEl.textContent = monthSum.toLocaleString() + " ‡∏ø"
  orderCountEl.textContent = saleRows.length

  renderDailyChart(dailyMap)
  renderProductChart(productSum)
  renderTable()
}

/* ================= CHART ================= */
function renderDailyChart(map) {
  if (dailyChart) dailyChart.destroy()
  dailyChart = new Chart(dailyCanvas, {
    type: "line",
    data: {
      labels: Object.keys(map),
      datasets: [{
        label: "‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢",
        data: Object.values(map),
        borderColor: "#22c55e",
        tension: 0.3
      }]
    }
  })
}

function renderProductChart(map) {
  if (productChart) productChart.destroy()

  const labels = Object.keys(map).map(id => productMap[id] || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠")
  const values = Object.values(map)

  productChart = new Chart(productCanvas, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢",
        data: values,
        backgroundColor: "#3b82f6"
      }]
    }
  })
}

/* ================= TABLE ================= */
function renderTable() {
  saleTable.innerHTML = ""
  saleRows.forEach(r => {
    const tr = document.createElement("tr")
    tr.innerHTML = `
      <td class="p-2">${thaiDate(r.orders.paid_at)}</td>
      <td class="p-2">${productMap[r.product_id]}</td>
      <td class="p-2 text-right">${r.qty}</td>
      <td class="p-2 text-right">${r.qty * r.price}</td>
    `
    saleTable.appendChild(tr)
  })
}

/* ================= EXPORT ================= */
function exportExcel() {
  const rows = saleRows.map(r => ({
    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: thaiDate(r.orders.paid_at),
    ‡πÄ‡∏°‡∏ô‡∏π: productMap[r.product_id],
    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: r.qty,
    ‡∏¢‡∏≠‡∏î: r.qty * r.price
  }))
  const ws = XLSX.utils.json_to_sheet(rows)
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, "Sales")
  XLSX.writeFile(wb, "sales.xlsx")
}

/* ================= INIT ================= */
;(async () => {
  await loadProducts()
  await loadSales()
})()
</script>

</body>
</html>
