<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>ðŸ“Š Dashboard PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen p-3">

<div class="max-w-7xl mx-auto space-y-4">

  <h1 class="text-2xl font-bold">ðŸ“Š Dashboard PRO (Owner)</h1>

  <!-- KPI -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
    <div class="bg-slate-800 p-4 rounded">
      <div class="text-sm text-gray-400">à¸¢à¸­à¸”à¸‚à¸²à¸¢à¸§à¸±à¸™à¸™à¸µà¹‰</div>
      <div id="todayTotal" class="text-2xl font-bold">0 à¸¿</div>
    </div>
    <div class="bg-slate-800 p-4 rounded">
      <div class="text-sm text-gray-400">à¸¢à¸­à¸”à¸‚à¸²à¸¢à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰</div>
      <div id="monthTotal" class="text-2xl font-bold">0 à¸¿</div>
    </div>
    <div class="bg-slate-800 p-4 rounded">
      <div class="text-sm text-gray-400">à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¸•à¹ˆà¸­à¸­à¸­à¸£à¹Œà¹€à¸”à¸­à¸£à¹Œ</div>
      <div id="avgBill" class="text-2xl font-bold">0 à¸¿</div>
    </div>
  </div>

  <!-- Insight -->
  <div class="bg-slate-800 p-4 rounded border-l-4 border-yellow-400">
    <h2 class="font-bold mb-2">ðŸ§  Insight</h2>
    <div id="insightBox" class="text-sm space-y-1"></div>
  </div>

  <!-- Charts -->
  <div class="grid md:grid-cols-2 gap-4">
    <div class="bg-slate-800 p-4 rounded">
      <h2 class="font-bold mb-2">ðŸ“ˆ à¸¢à¸­à¸”à¸‚à¸²à¸¢à¸£à¸²à¸¢à¸§à¸±à¸™ (7 à¸§à¸±à¸™)</h2>
      <canvas id="dailyChart"></canvas>
    </div>
    <div class="bg-slate-800 p-4 rounded">
      <h2 class="font-bold mb-2">ðŸ”¥ à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µ</h2>
      <canvas id="topProductChart"></canvas>
    </div>
  </div>

  <!-- Forecast -->
  <div class="bg-slate-800 p-4 rounded">
    <h2 class="font-bold mb-2">ðŸ”® Forecast 7 à¸§à¸±à¸™</h2>
    <canvas id="forecastChart"></canvas>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const sb = supabase.createClient(
  "https://nvsptbbvxjulrpdebrhn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
)

/* ================= ELEMENT ================= */
const todayTotalEl = document.getElementById("todayTotal")
const monthTotalEl = document.getElementById("monthTotal")
const avgBillEl = document.getElementById("avgBill")
const insightBox = document.getElementById("insightBox")

let dailyChart, topChart, forecastChart

/* ================= UTILS ================= */
function toTH(date) {
  const d = new Date(date)
  d.setHours(d.getHours() + 7)
  return d
}
function dateKey(d) {
  return d.toISOString().slice(0,10)
}

/* ================= LOAD ================= */
async function loadDashboard() {

  // 1ï¸âƒ£ à¹‚à¸«à¸¥à¸” orders à¸—à¸µà¹ˆà¸ˆà¹ˆà¸²à¸¢à¹€à¸‡à¸´à¸™à¹à¸¥à¹‰à¸§
  const { data: orders } = await sb
    .from("orders")
    .select("id, paid_at")
    .eq("status", "paid")

  if (!orders || orders.length === 0) return

  const orderIds = orders.map(o => o.id)

  // 2ï¸âƒ£ à¹‚à¸«à¸¥à¸” order_items
  const { data: items } = await sb
    .from("order_items")
    .select("order_id, product_id, qty, price")
    .in("order_id", orderIds)
    .eq("status", "done")

  // 3ï¸âƒ£ à¹‚à¸«à¸¥à¸”à¸ªà¸´à¸™à¸„à¹‰à¸²
  const { data: products } = await sb
    .from("products")
    .select("id,name")

  const productMap = {}
  products.forEach(p => productMap[p.id] = p.name)

  /* ================= CALC ================= */
  const today = new Date()
  const todayKey = dateKey(today)
  const monthKey = todayKey.slice(0,7)

  let todayTotal = 0
  let monthTotal = 0
  let billTotal = {}
  let dailySum = {}
  let productSum = {}

  orders.forEach(o => {
    const d = toTH(o.paid_at)
    const dk = dateKey(d)
    billTotal[o.id] = 0

    items.filter(i => i.order_id === o.id).forEach(i => {
      const total = i.qty * i.price
      billTotal[o.id] += total
      dailySum[dk] = (dailySum[dk] || 0) + total
      productSum[i.product_id] =
        (productSum[i.product_id] || 0) + i.qty
    })

    if (dk === todayKey) todayTotal += billTotal[o.id]
    if (dk.startsWith(monthKey)) monthTotal += billTotal[o.id]
  })

  const avgBill =
    Object.values(billTotal).reduce((a,b)=>a+b,0) /
    Object.keys(billTotal).length

  todayTotalEl.textContent = todayTotal.toLocaleString() + " à¸¿"
  monthTotalEl.textContent = monthTotal.toLocaleString() + " à¸¿"
  avgBillEl.textContent = Math.round(avgBill).toLocaleString() + " à¸¿"

  /* ================= INSIGHT ================= */
  const bestDay = Object.entries(dailySum)
    .sort((a,b)=>b[1]-a[1])[0]

  insightBox.innerHTML = `
    <div>â€¢ à¸§à¸±à¸™à¸—à¸µà¹ˆà¸‚à¸²à¸¢à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸”: <b>${bestDay?.[0]}</b></div>
    <div>â€¢ à¸¢à¸­à¸”à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¸•à¹ˆà¸­à¸šà¸´à¸¥: <b>${Math.round(avgBill)} à¸šà¸²à¸—</b></div>
    <div>â€¢ à¸–à¹‰à¸²à¹€à¸žà¸´à¹ˆà¸¡à¸¢à¸­à¸”à¸•à¹ˆà¸­à¸šà¸´à¸¥ +10% â†’ à¸£à¸²à¸¢à¹„à¸”à¹‰à¹€à¸žà¸´à¹ˆà¸¡à¸—à¸±à¸™à¸—à¸µ</div>
  `

  /* ================= CHARTS ================= */
  renderDailyChart(dailySum)
  renderTopProductChart(productSum, productMap)
  renderForecastChart(dailySum)
}

/* ================= CHART FUNC ================= */
function renderDailyChart(map) {
  if (dailyChart) dailyChart.destroy()
  const labels = Object.keys(map).slice(-7)
  dailyChart = new Chart(document.getElementById("dailyChart"), {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "à¸¢à¸­à¸”à¸‚à¸²à¸¢",
        data: labels.map(l => map[l]),
        borderColor: "#22c55e",
        tension: 0.3
      }]
    }
  })
}

function renderTopProductChart(map, pmap) {
  if (topChart) topChart.destroy()
  const sorted = Object.entries(map)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,5)

  topChart = new Chart(document.getElementById("topProductChart"), {
    type: "bar",
    data: {
      labels: sorted.map(i => pmap[i[0]]),
      datasets: [{
        data: sorted.map(i => i[1]),
        backgroundColor: "#facc15"
      }]
    }
  })
}

function renderForecastChart(map) {
  if (forecastChart) forecastChart.destroy()
  const values = Object.values(map)
  const avg = values.reduce((a,b)=>a+b,0) / values.length
  const data = Array.from({length:7},()=>Math.round(avg))

  forecastChart = new Chart(document.getElementById("forecastChart"), {
    type: "line",
    data: {
      labels: ["D+1","D+2","D+3","D+4","D+5","D+6","D+7"],
      datasets: [{
        label: "Forecast",
        data,
        borderColor: "#60a5fa",
        tension: 0.3
      }]
    }
  })
}

/* ================= INIT ================= */
loadDashboard()
</script>

</body>
</html>
