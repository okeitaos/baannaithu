<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>üìä Dashboard PRO (Owner Mode)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen p-3">

<div class="max-w-7xl mx-auto space-y-4">

  <h1 class="text-2xl font-bold">üåô Owner Dashboard (16:00‚Äì22:00)</h1>

  <!-- KPI -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
    <div class="bg-slate-800 p-4 rounded">
      <div class="text-sm text-gray-400">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
      <div id="avgPerHour" class="text-2xl font-bold">0 ‡∏ø</div>
      <div class="text-xs text-gray-500">‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô 6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
    </div>
    <div class="bg-slate-800 p-4 rounded">
      <div class="text-sm text-gray-400">‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ 7 ‡∏ß‡∏±‡∏ô</div>
      <div id="forecast7" class="text-2xl font-bold">0 ‡∏ø</div>
      <div class="text-xs text-gray-500">‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
    </div>
  </div>

  <!-- INSIGHT BOX -->
  <div class="bg-slate-800 p-4 rounded border-l-4 border-yellow-400">
    <h2 class="font-bold mb-2">üß† Insight ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô</h2>
    <div id="insightBox" class="space-y-1 text-sm"></div>
  </div>

  <!-- HOURLY CHART -->
  <div class="bg-slate-800 p-4 rounded">
    <h2 class="font-bold mb-2">‚è∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</h2>
    <canvas id="hourlyChart"></canvas>
  </div>

  <!-- FORECAST CHART -->
  <div class="bg-slate-800 p-4 rounded">
    <h2 class="font-bold mb-2">üìà Forecast ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (7 ‡∏ß‡∏±‡∏ô)</h2>
    <canvas id="forecastChart"></canvas>
  </div>

  <!-- MENU BY TIME -->
  <div class="bg-slate-800 p-4 rounded">
    <h2 class="font-bold mb-2">üçú ‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h2>

    <div class="grid md:grid-cols-3 gap-3 text-sm">
      <div>
        <div class="font-bold mb-1">16:00‚Äì18:00</div>
        <div id="menuEarly"></div>
      </div>
      <div>
        <div class="font-bold mb-1">18:00‚Äì20:00</div>
        <div id="menuPeak"></div>
      </div>
      <div>
        <div class="font-bold mb-1">20:00‚Äì22:00</div>
        <div id="menuLate"></div>
      </div>
    </div>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const sb = supabase.createClient(
  "https://nvsptbbvxjulrpdebrhn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
)

/* ================= ELEMENT ================= */
const avgPerHourEl = document.getElementById("avgPerHour")
const forecast7El = document.getElementById("forecast7")
const insightBoxEl = document.getElementById("insightBox")

const hourlyCanvas = document.getElementById("hourlyChart")
const forecastCanvas = document.getElementById("forecastChart")

const menuEarlyEl = document.getElementById("menuEarly")
const menuPeakEl = document.getElementById("menuPeak")
const menuLateEl = document.getElementById("menuLate")

let hourlyChart, forecastChart

/* ================= UTILS ================= */
function thaiTime(dateStr) {
  const d = new Date(dateStr)
  d.setHours(d.getHours() + 7)
  return d
}

function slotByHour(h) {
  if (h < 18) return "early"
  if (h < 20) return "peak"
  return "late"
}

/* ================= LOAD ================= */
async function loadDashboard() {
  const { data } = await sb
    .from("order_items")
    .select(`
      qty,
      price,
      product_id,
      products(name),
      orders!inner(paid_at)
    `)
    .eq("status", "done")

  const rows = data || []

  const hourlySum = {16:0,17:0,18:0,19:0,20:0,21:0}
  const dailySum = {}
  const menuGroup = { early:{}, peak:{}, late:{} }

  let totalRevenue = 0

  rows.forEach(r => {
    const t = thaiTime(r.orders.paid_at)
    const h = t.getHours()
    if (h < 16 || h > 21) return

    const total = r.qty * r.price
    totalRevenue += total
    hourlySum[h] += total

    const dateKey = t.toISOString().slice(0,10)
    dailySum[dateKey] = (dailySum[dateKey] || 0) + total

    const slot = slotByHour(h)
    menuGroup[slot][r.products.name] =
      (menuGroup[slot][r.products.name] || 0) + r.qty
  })

  const avgPerHour = totalRevenue / 6
  avgPerHourEl.textContent =
    Math.round(avgPerHour).toLocaleString() + " ‡∏ø"

  // Forecast 7 days
  const avgPerDay = Object.values(dailySum).reduce((a,b)=>a+b,0) /
                    Math.max(Object.keys(dailySum).length,1)
  const forecast7 = Math.round(avgPerDay * 7)
  forecast7El.textContent = forecast7.toLocaleString() + " ‡∏ø"

  renderInsight(avgPerHour, hourlySum, menuGroup)
  renderHourlyChart(hourlySum)
  renderForecastChart(avgPerDay)
  renderMenu(menuEarlyEl, menuGroup.early)
  renderMenu(menuPeakEl, menuGroup.peak)
  renderMenu(menuLateEl, menuGroup.late)
}

/* ================= INSIGHT ================= */
function renderInsight(avgPerHour, hourlySum, menuGroup) {
  insightBoxEl.innerHTML = ""

  const peakHour = Object.entries(hourlySum)
    .sort((a,b)=>b[1]-a[1])[0]

  insightBoxEl.innerHTML += `
    <div>‚Ä¢ ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: <b>${peakHour[0]}:00</b></div>
  `

  if (peakHour[1] > avgPerHour * 1.3) {
    insightBoxEl.innerHTML += `
      <div>‚Ä¢ ‡∏ä‡πà‡∏ß‡∏á‡∏û‡∏µ‡∏Ñ‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å üëâ ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏£‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</div>
    `
  }

  if (hourlySum[21] < avgPerHour * 0.6) {
    insightBoxEl.innerHTML += `
      <div>‚Ä¢ ‡∏´‡∏•‡∏±‡∏á 21:00 ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡∏Å üëâ ‡∏î‡∏±‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏™‡∏£‡∏¥‡∏° / ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</div>
    `
  }

  const topPeakMenu = Object.entries(menuGroup.peak)
    .sort((a,b)=>b[1]-a[1])[0]

  if (topPeakMenu) {
    insightBoxEl.innerHTML += `
      <div>‚Ä¢ ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏û‡∏µ‡∏Ñ: <b>${topPeakMenu[0]}</b></div>
    `
  }
}

/* ================= CHART ================= */
function renderHourlyChart(map) {
  if (hourlyChart) hourlyChart.destroy()
  hourlyChart = new Chart(hourlyCanvas, {
    type: "bar",
    data: {
      labels: ["16","17","18","19","20","21"],
      datasets: [{
        label: "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)",
        data: Object.values(map),
        backgroundColor: "#22c55e"
      }]
    }
  })
}

function renderForecastChart(avgPerDay) {
  if (forecastChart) forecastChart.destroy()

  const labels = Array.from({length:7},(_,i)=>`Day ${i+1}`)
  const data = labels.map(()=>Math.round(avgPerDay))

  forecastChart = new Chart(forecastCanvas, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ",
        data,
        borderColor: "#facc15",
        tension: 0.3
      }]
    }
  })
}

/* ================= MENU ================= */
function renderMenu(el, map) {
  el.innerHTML = ""
  const list = Object.entries(map)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,5)

  if (!list.length) {
    el.innerHTML = `<div class="text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`
    return
  }

  list.forEach(([name,qty],i)=>{
    const div = document.createElement("div")
    div.textContent = `${i+1}. ${name} (${qty})`
    el.appendChild(div)
  })
}

/* ================= INIT ================= */
loadDashboard()
</script>

</body>
</html>
