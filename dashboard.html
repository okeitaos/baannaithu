<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>üìä Dashboard PRO ULTRA</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<link rel="icon" href="data:,">
</head>

<body class="bg-slate-900 text-white p-3">

<div class="max-w-7xl mx-auto space-y-4">

<!-- HEADER -->
<div class="flex flex-col md:flex-row justify-between gap-3">
  <h1 class="text-2xl font-bold">üìä Dashboard PRO ULTRA</h1>

  <select id="rangeSelect" class="bg-slate-800 px-3 py-2 rounded">
    <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
    <option value="week">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</option>
    <option value="month" selected>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
    <option value="year">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</option>
  </select>
</div>

<!-- KPI -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-3">
  <div class="bg-slate-800 p-4 rounded">
    <div class="text-sm text-gray-400">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div>
    <div id="kpiRevenue" class="text-2xl font-bold">0</div>
  </div>
  <div class="bg-slate-800 p-4 rounded">
    <div class="text-sm text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•</div>
    <div id="kpiBills" class="text-2xl font-bold">0</div>
  </div>
  <div class="bg-slate-800 p-4 rounded">
    <div class="text-sm text-gray-400">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ / ‡∏ö‡∏¥‡∏•</div>
    <div id="kpiAvg" class="text-2xl font-bold">0</div>
  </div>
  <div class="bg-slate-800 p-4 rounded">
    <div class="text-sm text-gray-400">üîÆ Forecast 7 ‡∏ß‡∏±‡∏ô</div>
    <div id="kpiForecast" class="text-2xl font-bold">0</div>
  </div>
</div>

<!-- INSIGHT -->
<div class="bg-slate-800 p-4 rounded">
  <h2 class="font-bold mb-2">üß† Insight ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</h2>
  <ul id="insightBox" class="list-disc pl-5 space-y-1 text-sm"></ul>
</div>

<!-- CHART -->
<div class="bg-slate-800 p-4 rounded">
  <canvas id="revenueChart"></canvas>
</div>

<!-- MoM + AI -->
<div class="grid md:grid-cols-2 gap-3">
  <div class="bg-slate-800 p-4 rounded">
    <h2 class="font-bold mb-2">üßæ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
    <div id="momCompare" class="text-sm space-y-1"></div>
  </div>
  <div class="bg-slate-800 p-4 rounded">
    <h2 class="font-bold mb-2">üß† AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h2>
    <ul id="aiRecommend" class="list-disc pl-5 space-y-1 text-sm"></ul>
  </div>
</div>

<!-- MENU ANALYSIS -->
<div class="grid md:grid-cols-2 gap-3">
  <div class="bg-slate-800 p-4 rounded">
    <h2 class="font-bold mb-2">üî• ‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏ß‡∏£‡∏î‡∏±‡∏ô</h2>
    <ul id="pushMenu" class="list-disc pl-5 space-y-1"></ul>
  </div>
  <div class="bg-slate-800 p-4 rounded">
    <h2 class="font-bold mb-2">üßä ‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏ß‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏õ‡∏£‡∏±‡∏ö / ‡∏ï‡∏±‡∏î</h2>
    <ul id="cutMenu" class="list-disc pl-5 space-y-1"></ul>
  </div>
</div>

<button onclick="exportExcel()" class="bg-green-600 px-4 py-2 rounded font-bold">
üì• Export Excel
</button>

</div>

<script>
/* ================= CONFIG ================= */
const sb = supabase.createClient(
  "https://nvsptbbvxjulrpdebrhn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
)

let productName = {}
let chart

/* ================= LOAD PRODUCTS ================= */
async function loadProducts() {
  const { data } = await sb.from("products").select("id,name")
  ;(data||[]).forEach(p => productName[p.id] = p.name)
}

/* ================= DATE ================= */
function rangeStart(type){
  const d = new Date()
  if(type==="today") d.setHours(0,0,0,0)
  if(type==="week") d.setDate(d.getDate()-d.getDay())
  if(type==="month") d.setDate(1)
  if(type==="year"){ d.setMonth(0); d.setDate(1) }
  return d.toISOString()
}

function monthRange(offset){
  const d = new Date()
  d.setMonth(d.getMonth()+offset,1)
  return {
    start: new Date(d.getFullYear(), d.getMonth(), 1).toISOString(),
    end: new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59).toISOString()
  }
}

/* ================= DASHBOARD ================= */
async function loadDashboard(){
  const start = rangeStart(rangeSelect.value)

  const { data } = await sb
    .from("order_items")
    .select("product_id,qty,price,created_at")
    .eq("status","done")
    .gte("created_at", start)

  const rows = data || []

  let revenue=0, daily={}, menu={}, hours={}

  rows.forEach(r=>{
    const amount=r.price*r.qty
    revenue+=amount

    const day=r.created_at.slice(0,10)
    daily[day]=(daily[day]||0)+amount

    menu[r.product_id]=(menu[r.product_id]||0)+r.qty

    const h=new Date(r.created_at).getHours()
    if(h>=16 && h<=22) hours[h]=(hours[h]||0)+amount
  })

  const days=Object.keys(daily).length||1
  const bills=days

  kpiRevenue.textContent=revenue.toLocaleString()
  kpiBills.textContent=bills
  kpiAvg.textContent=Math.round(revenue/bills||0).toLocaleString()
  kpiForecast.textContent=Math.round((revenue/days)*7).toLocaleString()

  if(chart) chart.destroy()
  chart=new Chart(revenueChart,{
    type:"line",
    data:{ labels:Object.keys(daily),
      datasets:[{ label:"‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ", data:Object.values(daily), borderColor:"#22c55e", tension:.3 }]
    }
  })

  pushMenu.innerHTML=""
  cutMenu.innerHTML=""
  const totalQty=Object.values(menu).reduce((a,b)=>a+b,0)||1

  Object.entries(menu).forEach(([id,qty])=>{
    const name=productName[id]||"‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö"
    const ratio=qty/totalQty
    if(ratio>0.2) pushMenu.innerHTML+=`<li>${name} (${qty})</li>`
    if(ratio<0.05) cutMenu.innerHTML+=`<li>${name} (${qty})</li>`
  })

  insightBox.innerHTML=""
  const peak=Object.entries(hours).sort((a,b)=>b[1]-a[1])[0]
  if(peak) insightBox.innerHTML+=`<li>‡∏ä‡πà‡∏ß‡∏á‡∏û‡∏µ‡∏Ñ: ${peak[0]}:00 ‚Äì ${peak[0]}:59</li>`
  if(revenue/days>5000) insightBox.innerHTML+=`<li>‡∏¢‡∏≠‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏î‡∏µ ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°</li>`
}

/* ================= MoM + AI ================= */
async function loadMoMAndAI(){
  const cur=monthRange(0)
  const prev=monthRange(-1)

  const [c,p]=await Promise.all([
    sb.from("order_items").select("product_id,qty,price").eq("status","done").gte("created_at",cur.start).lte("created_at",cur.end),
    sb.from("order_items").select("product_id,qty,price").eq("status","done").gte("created_at",prev.start).lte("created_at",prev.end)
  ])

  const sum=r=>r.reduce((s,i)=>s+i.price*i.qty,0)
  const curTotal=sum(c.data||[])
  const prevTotal=sum(p.data||[])
  const diff=prevTotal?(((curTotal-prevTotal)/prevTotal)*100).toFixed(1):"100"

  momCompare.innerHTML=`
    <div>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <b>${curTotal.toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó</div>
    <div>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô: <b>${prevTotal.toLocaleString()}</b> ‡∏ö‡∏≤‡∏ó</div>
    <div>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°: <b class="${diff>=0?'text-green-400':'text-red-400'}">${diff}%</b></div>
  `

  const map=r=>{
    const m={}
    r.forEach(i=>m[i.product_id]=(m[i.product_id]||0)+i.qty)
    return m
  }

  const cm=map(c.data||[])
  const pm=map(p.data||[])

  aiRecommend.innerHTML=""
  Object.keys(productName).forEach(id=>{
    const c=cm[id]||0, p=pm[id]||0
    if(c>=p*1.5 && c>=5) aiRecommend.innerHTML+=`<li>üî• ${productName[id]} ‡πÇ‡∏ï ‚Üí ‡∏Ñ‡∏ß‡∏£‡∏î‡∏±‡∏ô</li>`
    else if(c<=p*0.5 && p>=5) aiRecommend.innerHTML+=`<li>‚ö†Ô∏è ${productName[id]} ‡∏¢‡∏≠‡∏î‡∏ï‡∏Å</li>`
    else if(c<=1 && p<=1) aiRecommend.innerHTML+=`<li>üßä ${productName[id]} ‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≥ ‚Üí ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏ï‡∏±‡∏î</li>`
  })

  if(!aiRecommend.innerHTML) aiRecommend.innerHTML="<li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</li>"
}

/* ================= EXPORT ================= */
function exportExcel(){
  const ws=XLSX.utils.aoa_to_sheet([
    ["‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°",kpiRevenue.textContent],
    ["Forecast 7 ‡∏ß‡∏±‡∏ô",kpiForecast.textContent]
  ])
  const wb=XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb,ws,"Summary")
  XLSX.writeFile(wb,"dashboard_pro_ultra.xlsx")
}

rangeSelect.onchange=()=>{ loadDashboard(); loadMoMAndAI() }

;(async()=>{
  await loadProducts()
  loadDashboard()
  loadMoMAndAI()
})()
</script>

</body>
</html>
