<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>üìä Dashboard PRO+</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="icon" href="data:,">
</head>

<body class="bg-slate-900 text-white min-h-screen p-3 md:p-6">

<div class="max-w-7xl mx-auto space-y-6">

  <!-- HEADER -->
  <div class="flex flex-col md:flex-row md:justify-between gap-3">
    <h1 class="text-2xl font-bold">üìä Dashboard PRO+</h1>
    <div class="flex gap-2 flex-wrap">
      <button onclick="setRange('today')" class="btn">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
      <button onclick="setRange('week')" class="btn">7 ‡∏ß‡∏±‡∏ô</button>
      <button onclick="setRange('month')" class="btn">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
      <button onclick="setRange('year')" class="btn">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</button>
      <button onclick="exportCSV()" class="btn bg-green-600">üìä Export Excel</button>
    </div>
  </div>

  <!-- SUMMARY -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
    <div class="card"><div class="label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</div><div id="totalRevenue" class="value">0 ‡∏ø</div></div>
    <div class="card"><div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div><div id="billCount" class="value">0</div></div>
    <div class="card"><div class="label">‡∏Ç‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ / ‡∏ß‡∏±‡∏ô</div><div id="avgPerDay" class="value">0 ‡∏ø</div></div>
    <div class="card"><div class="label">‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div><div id="bestHour" class="value">-</div></div>
  </div>

  <!-- CHART -->
  <div class="bg-slate-800 rounded-xl p-4">
    <h2 class="font-bold mb-3">üìà ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô</h2>
    <canvas id="revenueChart" height="100"></canvas>
  </div>

  <!-- FORECAST -->
  <div class="bg-indigo-700 rounded-xl p-4">
    <h2 class="font-bold mb-2">üîÆ Forecast ‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏´‡∏ô‡πâ‡∏≤</h2>
    <div id="forecastBox" class="text-xl font-bold">-</div>
    <div class="text-sm opacity-80">* ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
  </div>

  <!-- MENU ANALYSIS -->
  <div class="grid md:grid-cols-2 gap-4">
    <div class="bg-slate-800 rounded-xl p-4">
      <h2 class="font-bold mb-2">üî• ‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏ß‡∏£‡∏î‡∏±‡∏ô</h2>
      <ul id="pushMenu" class="list-disc ml-5 text-sm space-y-1"></ul>
    </div>
    <div class="bg-slate-800 rounded-xl p-4">
      <h2 class="font-bold mb-2">üßä ‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏ß‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏õ‡∏£‡∏±‡∏ö / ‡∏ï‡∏±‡∏î</h2>
      <ul id="cutMenu" class="list-disc ml-5 text-sm space-y-1"></ul>
    </div>
  </div>

</div>

<style>
.btn{background:#334155;padding:.5rem .75rem;border-radius:.5rem}
.btn:hover{background:#475569}
.card{background:#1e293b;border-radius:.75rem;padding:1rem}
.label{font-size:.8rem;opacity:.7}
.value{font-size:1.4rem;font-weight:bold}
</style>

<script>
/* ================= CONFIG ================= */
const sb = supabase.createClient(
  "https://nvsptbbvxjulrpdebrhn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
)

let currentRange = "week"
let chart
let rawRows = []

/* ================= RANGE ================= */
function getFromDate(r){
  const d=new Date()
  if(r==="today") d.setHours(0,0,0,0)
  if(r==="week") d.setDate(d.getDate()-6)
  if(r==="month") return new Date(d.getFullYear(),d.getMonth(),1).toISOString()
  if(r==="year") return new Date(d.getFullYear(),0,1).toISOString()
  return d.toISOString()
}
function setRange(r){currentRange=r;loadDashboard()}

/* ================= LOAD ================= */
async function loadDashboard(){
  const from=getFromDate(currentRange)

  const {data}=await sb.from("order_items")
    .select("qty,price,created_at,product_id,orders!inner(status)")
    .eq("orders.status","paid")
    .gte("created_at",from)

  rawRows=data||[]

  let total=0,byDay={},byHour={},menu={}
  rawRows.forEach(r=>{
    const sum=r.price*r.qty
    total+=sum
    const day=r.created_at.slice(0,10)
    byDay[day]=(byDay[day]||0)+sum
    const h=new Date(r.created_at).getHours()
    byHour[h]=(byHour[h]||0)+sum
    menu[r.product_id]=(menu[r.product_id]||0)+r.qty
  })

  document.getElementById("totalRevenue").textContent=total.toLocaleString()+" ‡∏ø"
  document.getElementById("billCount").textContent=rawRows.length
  document.getElementById("avgPerDay").textContent=
    (total/Object.keys(byDay).length||0).toFixed(0)+" ‡∏ø"

  const best=Object.entries(byHour).sort((a,b)=>b[1]-a[1])[0]
  document.getElementById("bestHour").textContent=best?`${best[0]}:00-${+best[0]+1}:00`:"-"

  if(chart) chart.destroy()
  chart=new Chart(revenueChart,{
    type:"line",
    data:{labels:Object.keys(byDay),datasets:[{data:Object.values(byDay),label:"‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ",borderColor:"#22d3ee",fill:false}]}
  })

  /* üîÆ Forecast */
  const last7=Object.values(byDay).slice(-7)
  const avg=last7.reduce((a,b)=>a+b,0)/7||0
  document.getElementById("forecastBox").textContent=
    "‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì "+Math.round(avg*7).toLocaleString()+" ‡∏ø"

  /* üì¶ Menu analysis */
  const push=[],cut=[]
  Object.entries(menu).forEach(([id,qty])=>{
    const ratio=qty/Object.values(menu).reduce((a,b)=>a+b,0)
    if(ratio>0.2) push.push(`‡πÄ‡∏°‡∏ô‡∏π ${id} (${qty} ‡∏ä‡∏≤‡∏°)`)
    if(ratio<0.05) cut.push(`‡πÄ‡∏°‡∏ô‡∏π ${id} (${qty} ‡∏ä‡∏≤‡∏°)`)
  })
  pushMenu.innerHTML=push.map(i=>`<li>${i}</li>`).join("")||"<li>-</li>"
  cutMenu.innerHTML=cut.map(i=>`<li>${i}</li>`).join("")||"<li>-</li>"
}

/* ================= EXPORT ================= */
function exportCSV(){
  let csv="date,product_id,qty,price,total\n"
  rawRows.forEach(r=>{
    csv+=`${r.created_at.slice(0,10)},${r.product_id},${r.qty},${r.price},${r.qty*r.price}\n`
  })
  const blob=new Blob([csv],{type:"text/csv"})
  const a=document.createElement("a")
  a.href=URL.createObjectURL(blob)
  a.download="sales.csv"
  a.click()
}

loadDashboard()
</script>

</body>
</html>
