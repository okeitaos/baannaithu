<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>ðŸ“Š Dashboard PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<link rel="icon" href="data:,">
</head>

<body class="bg-slate-900 text-white min-h-screen p-3">

<div class="max-w-7xl mx-auto space-y-4">

  <!-- HEADER -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <h1 class="text-2xl font-bold">ðŸ“Š Dashboard PRO</h1>

    <select
      id="rangeSelect"
      class="bg-slate-800 px-3 py-2 rounded">
      <option value="today">à¸§à¸±à¸™à¸™à¸µà¹‰</option>
      <option value="week">à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œà¸™à¸µà¹‰</option>
      <option value="month" selected>à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰</option>
      <option value="year">à¸›à¸µà¸™à¸µà¹‰</option>
    </select>
  </div>

  <!-- INSIGHT BOX -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
    <div class="bg-slate-800 p-4 rounded">
      <div class="text-sm text-gray-400">à¸¢à¸­à¸”à¸‚à¸²à¸¢à¸£à¸§à¸¡</div>
      <div id="totalSales" class="text-2xl font-bold">0</div>
    </div>
    <div class="bg-slate-800 p-4 rounded">
      <div class="text-sm text-gray-400">à¸ˆà¸³à¸™à¸§à¸™à¸šà¸´à¸¥</div>
      <div id="totalBills" class="text-2xl font-bold">0</div>
    </div>
    <div class="bg-slate-800 p-4 rounded">
      <div class="text-sm text-gray-400">à¸‚à¸²à¸¢à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ / à¸šà¸´à¸¥</div>
      <div id="avgBill" class="text-2xl font-bold">0</div>
    </div>
    <div class="bg-slate-800 p-4 rounded">
      <div class="text-sm text-gray-400">ðŸ”® Forecast à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œà¸«à¸™à¹‰à¸²</div>
      <div id="forecast" class="text-2xl font-bold">0</div>
    </div>
  </div>

  <!-- CHART -->
  <div class="bg-slate-800 p-4 rounded">
    <canvas id="salesChart"></canvas>
  </div>

  <!-- MENU ANALYSIS -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
    <div class="bg-slate-800 p-4 rounded">
      <h2 class="font-bold mb-2">ðŸ”¥ à¹€à¸¡à¸™à¸¹à¸„à¸§à¸£à¸”à¸±à¸™</h2>
      <ul id="pushMenu" class="list-disc pl-5 space-y-1"></ul>
    </div>
    <div class="bg-slate-800 p-4 rounded">
      <h2 class="font-bold mb-2">ðŸ§Š à¹€à¸¡à¸™à¸¹à¸„à¸§à¸£à¸žà¸´à¸ˆà¸²à¸£à¸“à¸²à¸›à¸£à¸±à¸š / à¸•à¸±à¸”</h2>
      <ul id="cutMenu" class="list-disc pl-5 space-y-1"></ul>
    </div>
  </div>

  <!-- EXPORT -->
  <button
    onclick="exportExcel()"
    class="bg-green-600 px-4 py-2 rounded font-bold">
    ðŸ“¥ Export Excel
  </button>

</div>

<script>
/* ================= CONFIG ================= */
const sb = supabase.createClient(
  "https://nvsptbbvxjulrpdebrhn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
)

/* ================= STATE ================= */
let productNameMap = {}
let chart

/* ================= LOAD PRODUCTS ================= */
async function loadProductNames() {
  const { data } = await sb.from("products").select("id,name")
  productNameMap = {}
  ;(data || []).forEach(p => productNameMap[p.id] = p.name)
}

/* ================= DATE RANGE ================= */
function getDateRange(type) {
  const now = new Date()
  let start = new Date()

  if (type === "today") {
    start.setHours(0,0,0,0)
  }
  if (type === "week") {
    start.setDate(now.getDate() - now.getDay())
  }
  if (type === "month") {
    start = new Date(now.getFullYear(), now.getMonth(), 1)
  }
  if (type === "year") {
    start = new Date(now.getFullYear(), 0, 1)
  }

  return start.toISOString()
}

/* ================= DASHBOARD ================= */
async function loadDashboard() {
  const range = rangeSelect.value
  const startDate = getDateRange(range)

  const { data: items } = await sb
    .from("order_items")
    .select("product_id,qty,price,created_at")
    .eq("status", "done")
    .gte("created_at", startDate)

  const rows = items || []

  // Summary
  let total = 0
  let menu = {}
  let daily = {}

  rows.forEach(r => {
    total += r.price * r.qty
    menu[r.product_id] = (menu[r.product_id] || 0) + r.qty

    const d = r.created_at.slice(0,10)
    daily[d] = (daily[d] || 0) + r.price * r.qty
  })

  totalSales.textContent = total.toLocaleString()
  totalBills.textContent = new Set(rows.map(r => r.created_at.slice(0,10))).size
  avgBill.textContent =
    totalBills.textContent > 0
      ? Math.round(total / totalBills.textContent).toLocaleString()
      : 0

  // Forecast (à¸„à¹ˆà¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¸•à¹ˆà¸­à¸§à¸±à¸™ x 7)
  const days = Object.keys(daily).length || 1
  forecast.textContent = Math.round((total / days) * 7).toLocaleString()

  // Chart
  const labels = Object.keys(daily)
  const values = Object.values(daily)

  if (chart) chart.destroy()
  chart = new Chart(salesChart, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "à¸¢à¸­à¸”à¸‚à¸²à¸¢",
        data: values,
        borderColor: "#22c55e",
        tension: 0.3
      }]
    }
  })

  // Menu Analysis
  const totalQty = Object.values(menu).reduce((a,b)=>a+b,0) || 1
  const push=[], cut=[]

  Object.entries(menu).forEach(([id,qty])=>{
    const ratio = qty / totalQty
    const name = productNameMap[id] || "à¹„à¸¡à¹ˆà¸—à¸£à¸²à¸šà¸Šà¸·à¹ˆà¸­"

    if (ratio > 0.2) push.push(`${name} (${qty} à¸Šà¸²à¸¡)`)
    if (ratio < 0.05) cut.push(`${name} (${qty} à¸Šà¸²à¸¡)`)
  })

  pushMenu.innerHTML = push.length ? push.map(i=>`<li>${i}</li>`).join("") : "<li>-</li>"
  cutMenu.innerHTML = cut.length ? cut.map(i=>`<li>${i}</li>`).join("") : "<li>-</li>"
}

/* ================= EXPORT ================= */
function exportExcel() {
  const wb = XLSX.utils.book_new()
  const ws = XLSX.utils.aoa_to_sheet([
    ["Dashboard Export"],
    ["à¸¢à¸­à¸”à¸‚à¸²à¸¢à¸£à¸§à¸¡", totalSales.textContent],
    ["Forecast à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œà¸«à¸™à¹‰à¸²", forecast.textContent]
  ])
  XLSX.utils.book_append_sheet(wb, ws, "Summary")
  XLSX.writeFile(wb, "dashboard.xlsx")
}

/* ================= INIT ================= */
rangeSelect.onchange = loadDashboard

;(async()=>{
  await loadProductNames()
  loadDashboard()
})()
</script>

</body>
</html>
