<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>ðŸ’° à¸„à¸´à¸”à¹€à¸‡à¸´à¸™ / à¸›à¸´à¸”à¸šà¸´à¸¥</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="icon" href="data:,">
</head>

<body class="bg-slate-900 text-white min-h-screen p-2 md:p-4">

<!-- ðŸ”Š à¹€à¸ªà¸µà¸¢à¸‡à¸„à¸´à¸”à¹€à¸‡à¸´à¸™ -->
<audio
  id="paySound"
  src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg">
</audio>

<div class="
  max-w-6xl mx-auto
  grid grid-cols-1 gap-3
  md:grid-cols-12 md:gap-4
">

  <!-- à¹‚à¸•à¹Šà¸° -->
  <div class="md:col-span-3 bg-slate-800 rounded-xl p-3">
    <h2 class="font-bold mb-3 text-lg">ðŸª‘ à¹‚à¸•à¹Šà¸°à¸—à¸µà¹ˆà¸žà¸£à¹‰à¸­à¸¡à¸„à¸´à¸”à¹€à¸‡à¸´à¸™</h2>
    <div
      id="tableList"
      class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-1 gap-2">
    </div>
  </div>

  <!-- à¸šà¸´à¸¥ -->
  <div class="md:col-span-9 bg-slate-800 rounded-xl p-3 flex flex-col">
    <h2 class="font-bold mb-3 text-lg">ðŸ§¾ à¸šà¸´à¸¥à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¹‚à¸•à¹Šà¸°</h2>

    <!-- à¸£à¸²à¸¢à¸à¸²à¸£à¸šà¸´à¸¥ -->
    <div
      id="billItems"
      class="space-y-2 mb-4 flex-1 overflow-y-auto max-h-[45vh] md:max-h-none">
    </div>

    <!-- à¸ªà¸£à¸¸à¸› / à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™ -->
    <div class="border-t pt-4 space-y-4">
      <div class="text-xl font-bold flex justify-between">
        <span>à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</span>
        <span><span id="totalPrice">0</span> à¸šà¸²à¸—</span>
      </div>

      <div class="flex gap-3">
        <button
          id="cashBtn"
          class="flex-1 bg-green-600 px-4 py-3 rounded text-lg">
          ðŸ’µ à¹€à¸‡à¸´à¸™à¸ªà¸”
        </button>
        <button
          id="qrBtn"
          class="flex-1 bg-blue-600 px-4 py-3 rounded text-lg">
          ðŸ“± PromptPay
        </button>
      </div>

      <div id="qrBox" class="hidden text-center">
        <img
          id="qrImg"
          class="mx-auto w-48 bg-white p-2 rounded" />
      </div>

      <button
        id="payBtn"
        class="w-full bg-yellow-500 py-3 rounded text-lg disabled:opacity-40"
        disabled>
        âœ… à¸¢à¸·à¸™à¸¢à¸±à¸™à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™
      </button>
    </div>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const sb = supabase.createClient(
  "https://nvsptbbvxjulrpdebrhn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
)

const PROMPTPAY_ID = "0936494961"

/* ================= SOUND AUTO UNLOCK ================= */
const paySound = document.getElementById("paySound")
let soundUnlocked = false

function unlockSoundOnce() {
  if (soundUnlocked) return
  paySound.play()
    .then(() => {
      paySound.pause()
      paySound.currentTime = 0
      soundUnlocked = true
      console.log("ðŸ”Š Sound unlocked")
    })
    .catch(() => {})
}

// à¹à¸•à¸°à¸­à¸°à¹„à¸£à¸à¹‡à¹„à¸”à¹‰à¸„à¸£à¸±à¹‰à¸‡à¹à¸£à¸ = à¹€à¸›à¸´à¸”à¹€à¸ªà¸µà¸¢à¸‡
document.addEventListener("click", unlockSoundOnce, { once: true })
document.addEventListener("touchstart", unlockSoundOnce, { once: true })

/* ================= STATE ================= */
let currentTableId = null
let paymentMethod = null
let productMap = {}
let tableMap = {}

/* ================= MASTER ================= */
async function loadProducts() {
  const { data } = await sb.from("products").select("id,name,price")
  ;(data || []).forEach(p => productMap[p.id] = p)
}

async function loadTables() {
  const { data } = await sb.from("tables").select("id,table_no")
  ;(data || []).forEach(t => tableMap[t.id] = t.table_no)
}

/* ================= LOAD TABLES ================= */
async function loadOpenTables() {
  tableList.innerHTML = ""

  const { data: orders } = await sb
    .from("orders")
    .select("table_id")
    .eq("status", "open")

  const tableIds = [...new Set((orders || []).map(o => o.table_id))]

  tableIds.forEach(tableId => {
    const btn = document.createElement("button")
    btn.className = "w-full bg-blue-600 py-3 rounded font-bold"
    btn.textContent = `à¹‚à¸•à¹Šà¸° ${tableMap[tableId]}`
    btn.onclick = () => loadBillByTable(tableId)
    tableList.appendChild(btn)
  })
}

/* ================= LOAD BILL ================= */
async function loadBillByTable(tableId) {
  currentTableId = tableId
  paymentMethod = null
  payBtn.disabled = true
  qrBox.classList.add("hidden")
  billItems.innerHTML = ""

  let total = 0

  const { data: orders } = await sb
    .from("orders")
    .select("id")
    .eq("table_id", tableId)
    .eq("status", "open")

  for (const o of orders || []) {
    const { data: items } = await sb
      .from("order_items")
      .select("product_id,qty")
      .eq("order_id", o.id)
      .eq("status", "done")

    ;(items || []).forEach(it => {
      const p = productMap[it.product_id]
      if (!p) return

      const price = p.price * it.qty
      total += price

      const div = document.createElement("div")
      div.className = "flex justify-between border-b border-slate-700 py-1"
      div.innerHTML = `
        <div>${p.name} x ${it.qty}</div>
        <div>${price} à¸šà¸²à¸—</div>
      `
      billItems.appendChild(div)
    })
  }

  totalPrice.textContent = total
}

/* ================= PAYMENT METHOD ================= */
cashBtn.onclick = () => {
  paymentMethod = "cash"
  qrBox.classList.add("hidden")
  payBtn.disabled = false
}

qrBtn.onclick = () => {
  paymentMethod = "promptpay"
  qrImg.src = `https://promptpay.io/${PROMPTPAY_ID}/${totalPrice.textContent}.png`
  qrBox.classList.remove("hidden")
  payBtn.disabled = false
}

/* ================= PAY ================= */
payBtn.onclick = async () => {
  if (!currentTableId || !paymentMethod) return

  const confirm = await Swal.fire({
    title: `à¸¢à¸·à¸™à¸¢à¸±à¸™à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™ à¹‚à¸•à¹Šà¸° ${tableMap[currentTableId]}?`,
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™",
    cancelButtonText: "à¸¢à¸à¹€à¸¥à¸´à¸"
  })
  if (!confirm.isConfirmed) return

  const { error } = await sb.rpc("close_orders_by_table", {
    p_table_id: currentTableId,
    p_method: paymentMethod
  })

  if (error) {
    Swal.fire("à¸œà¸´à¸”à¸žà¸¥à¸²à¸”", error.message, "error")
    return
  }

  await sb.from("tables")
    .update({ status: "available" })
    .eq("id", currentTableId)

  // ðŸ”” à¹€à¸ªà¸µà¸¢à¸‡à¸•à¸­à¸™à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ
  if (soundUnlocked) {
    paySound.currentTime = 0
    paySound.play().catch(()=>{})
  }

  Swal.fire("à¸ªà¸³à¹€à¸£à¹‡à¸ˆ", "à¸›à¸´à¸”à¸šà¸´à¸¥à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢", "success")

  currentTableId = null
  billItems.innerHTML = ""
  totalPrice.textContent = 0
  payBtn.disabled = true
  qrBox.classList.add("hidden")

  loadOpenTables()
}

/* ================= INIT ================= */
;(async () => {
  await loadProducts()
  await loadTables()
  await loadOpenTables()
})()
</script>

</body>
</html>
