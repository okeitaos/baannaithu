<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>ðŸ’° à¸„à¸´à¸”à¹€à¸‡à¸´à¸™ / à¸›à¸´à¸”à¸šà¸´à¸¥</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="icon" href="data:,">
</head>

<body class="bg-slate-900 text-white min-h-screen p-4">

<div class="max-w-6xl mx-auto grid grid-cols-12 gap-4">

  <div class="col-span-3 bg-slate-800 rounded-xl p-4">
    <h2 class="font-bold mb-3">ðŸª‘ à¹‚à¸•à¹Šà¸°à¸—à¸µà¹ˆà¸žà¸£à¹‰à¸­à¸¡à¸„à¸´à¸”à¹€à¸‡à¸´à¸™</h2>
    <div id="tableList" class="space-y-2"></div>
  </div>

  <div class="col-span-9 bg-slate-800 rounded-xl p-4">
    <h2 class="font-bold mb-3">ðŸ§¾ à¸šà¸´à¸¥</h2>

    <div id="billItems" class="space-y-2 mb-4"></div>

    <div class="border-t pt-4 space-y-4">
      <div class="text-xl font-bold">
        à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”: <span id="totalPrice">0</span> à¸šà¸²à¸—
      </div>

      <div class="flex gap-3">
        <button id="cashBtn" class="bg-green-600 px-4 py-2 rounded">ðŸ’µ à¹€à¸‡à¸´à¸™à¸ªà¸”</button>
        <button id="qrBtn" class="bg-blue-600 px-4 py-2 rounded">ðŸ“± PromptPay</button>
      </div>

      <button id="payBtn"
        class="w-full bg-yellow-500 py-2 rounded disabled:opacity-40"
        disabled>
        âœ… à¸¢à¸·à¸™à¸¢à¸±à¸™à¸Šà¸³à¸£à¸°à¹€à¸‡à¸´à¸™
      </button>
    </div>
  </div>

</div>

<script>
const sb = supabase.createClient(
  "https://nvsptbbvxjulrpdebrhn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
)

let currentOrderId = null
let paymentMethod = null
let productMap = {}
let tableMap = {}

/* ===== master ===== */
async function loadProducts() {
  const { data } = await sb.from("products").select("id,name,price")
  data.forEach(p => productMap[p.id] = p)
}

async function loadTables() {
  const { data } = await sb.from("tables").select("id,table_no")
  data.forEach(t => tableMap[t.id] = t.table_no)
}

/* ===== load tables ===== */
async function loadOpenTables() {
  tableList.innerHTML = ""

  const { data: orders } = await sb
    .from("orders")
    .select("id,table_id")
    .eq("status", "open")

  orders.forEach(o => {
    const btn = document.createElement("button")
    btn.className = "w-full bg-blue-600 py-2 rounded"
    btn.textContent = `à¹‚à¸•à¹Šà¸° ${tableMap[o.table_id]}`
    btn.onclick = () => loadBill(o.id)
    tableList.appendChild(btn)
  })
}

/* ===== load bill ===== */
async function loadBill(orderId) {
  currentOrderId = orderId
  paymentMethod = null
  payBtn.disabled = true
  billItems.innerHTML = ""
  let total = 0

  const { data: items } = await sb
    .from("order_items")
    .select("*")
    .eq("order_id", orderId)
    .eq("status", "done")

  items.forEach(it => {
    const p = productMap[it.product_id]
    const price = p.price * it.qty
    total += price

    billItems.innerHTML += `
      <div class="flex justify-between border-b py-1">
        <div>${p.name} x ${it.qty}</div>
        <div>${price} à¸šà¸²à¸—</div>
      </div>
    `
  })

  totalPrice.textContent = total
}

/* ===== payment ===== */
cashBtn.onclick = () => {
  paymentMethod = "cash"
  payBtn.disabled = false
}

qrBtn.onclick = () => {
  paymentMethod = "promptpay"
  payBtn.disabled = false
}

payBtn.onclick = async () => {
  if (!currentOrderId || !paymentMethod) return

  await sb.from("orders")
    .update({
      status: "paid",
      payment_method: paymentMethod,
      paid_at: new Date()
    })
    .eq("id", currentOrderId)

  await sb.from("tables")
    .update({ status: "available" })
    .eq("id", currentOrderId)

  Swal.fire("à¸ªà¸³à¹€à¸£à¹‡à¸ˆ", "à¸›à¸´à¸”à¸šà¸´à¸¥à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢", "success")
  loadOpenTables()
}

;(async () => {
  await loadProducts()
  await loadTables()
  await loadOpenTables()
})()
</script>

</body>
</html>
