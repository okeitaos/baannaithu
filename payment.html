<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>üí∞ ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô / ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link rel="icon" href="data:,">
</head>

<body class="bg-slate-900 text-white min-h-screen p-4">

<div class="max-w-6xl mx-auto grid grid-cols-12 gap-4">

  <!-- ‡πÇ‡∏ï‡πä‡∏∞ -->
  <div class="col-span-3 bg-slate-800 rounded-xl p-4">
    <h2 class="font-bold mb-3">ü™ë ‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•</h2>
    <div id="tableList" class="space-y-2"></div>
  </div>

  <!-- ‡∏ö‡∏¥‡∏• -->
  <div class="col-span-9 bg-slate-800 rounded-xl p-4">
    <h2 class="font-bold mb-3">üßæ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2>

    <div id="billItems" class="space-y-2 mb-4"></div>

    <div class="border-t pt-4 space-y-4">
      <div class="text-xl font-bold">
        ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalPrice">0</span> ‡∏ö‡∏≤‡∏ó
      </div>

      <!-- ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
      <div class="flex gap-3">
        <button id="cashBtn" class="bg-green-600 px-4 py-2 rounded">
          üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
        </button>
        <button id="qrBtn" class="bg-blue-600 px-4 py-2 rounded">
          üì± PromptPay
        </button>
      </div>

      <!-- QR PromptPay -->
      <div id="qrBox" class="hidden text-center">
        <img
          id="qrImg"
          class="mx-auto w-48 bg-white p-2 rounded"
          src=""
        />
        <p class="text-sm text-gray-300 mt-2">
          ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
        </p>
      </div>

      <button
        id="payBtn"
        class="w-full bg-yellow-500 py-2 rounded disabled:opacity-40"
        disabled>
        ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
      </button>
    </div>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const sb = supabase.createClient(
  "https://nvsptbbvxjulrpdebrhn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
)

// üîß ‡πÉ‡∏™‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå PromptPay ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä.
const PROMPTPAY_ID = "0936494961"

/* ================= STATE ================= */
let currentOrder = null
let productMap = {}
let tableMap = {}
let paymentMethod = null

/* ================= LOAD MASTER ================= */
async function loadProducts() {
  const { data } = await sb.from("products").select("id,name,price")
  ;(data || []).forEach(p => productMap[p.id] = p)
}

async function loadTables() {
  const { data } = await sb.from("tables").select("id,table_no")
  ;(data || []).forEach(t => tableMap[t.id] = t.table_no)
}

/* ================= LOAD ORDERS ================= */
async function loadOrders() {
  const { data } = await sb
    .from("orders")
    .select("*")
    .neq("status", "paid")
    .order("created_at", { ascending: true })

  tableList.innerHTML = ""

  ;(data || []).forEach(o => {
    const btn = document.createElement("button")
    btn.className = "w-full bg-blue-600 py-2 rounded"
    btn.textContent = `‡πÇ‡∏ï‡πä‡∏∞ ${tableMap[o.table_id] || "-"}`
    btn.onclick = () => loadBill(o)
    tableList.appendChild(btn)
  })
}

/* ================= LOAD BILL ================= */
async function loadBill(order) {
  currentOrder = order
  paymentMethod = null
  qrBox.classList.add("hidden")
  payBtn.disabled = true

  const { data } = await sb
    .from("order_items")
    .select("*")
    .eq("order_id", order.id)

  let total = 0
  billItems.innerHTML = ""

  ;(data || []).forEach(it => {
    const p = productMap[it.product_id]
    if (!p) return
    const price = p.price * it.qty
    total += price

    const div = document.createElement("div")
    div.className = "flex justify-between border-b border-slate-700 py-1"
    div.innerHTML = `
      <div>${p.name} x ${it.qty}</div>
      <div>${price} ‡∏ö‡∏≤‡∏ó</div>
    `
    billItems.appendChild(div)
  })

  totalPrice.textContent = total
}

/* ================= PAYMENT METHOD ================= */
cashBtn.onclick = () => {
  paymentMethod = "cash"
  qrBox.classList.add("hidden")
  payBtn.disabled = false
}

qrBtn.onclick = () => {
  paymentMethod = "promptpay"
  qrBox.classList.remove("hidden")

  // ‡πÉ‡∏ä‡πâ API ‡∏™‡∏£‡πâ‡∏≤‡∏á QR PromptPay
  qrImg.src =
    `https://promptpay.io/${PROMPTPAY_ID}/${totalPrice.textContent}.png`

  payBtn.disabled = false
}

/* ================= CONFIRM PAY ================= */
payBtn.onclick = async () => {
  if (!currentOrder || !paymentMethod) return

  const confirm = await Swal.fire({
    title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô?",
    text: paymentMethod === "cash"
      ? "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î"
      : "PromptPay",
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
  })

  if (!confirm.isConfirmed) return

  // ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•
  await sb.from("orders")
    .update({
      status: "paid",
      payment_method: paymentMethod,
      paid_at: new Date()
    })
    .eq("id", currentOrder.id)

  // ‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏ï‡πä‡∏∞
  await sb.from("tables")
    .update({ status: "available" })
    .eq("id", currentOrder.table_id)

  Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success")

  currentOrder = null
  billItems.innerHTML = ""
  totalPrice.textContent = 0
  payBtn.disabled = true
  qrBox.classList.add("hidden")

  loadOrders()
}

/* ================= INIT ================= */
;(async () => {
  await loadProducts()
  await loadTables()
  await loadOrders()
})()
</script>

</body>
</html>
