<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>ğŸ‘¨â€ğŸ³ Kitchen</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="icon" href="data:,">
</head>

<body class="bg-slate-900 text-white min-h-screen p-4">

<div class="max-w-7xl mx-auto">
  <h1 class="text-2xl font-bold mb-4">ğŸ‘¨â€ğŸ³ à¸«à¸™à¹‰à¸²à¸„à¸£à¸±à¸§</h1>
  <div id="billList" class="grid md:grid-cols-2 gap-4"></div>
</div>

<script>
const sb = supabase.createClient(
  "https://nvsptbbvxjulrpdebrhn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
)

const billList = document.getElementById("billList")
let productMap = {}
let tableMap = {}
let orderTableMap = {}

/* ===== master ===== */
async function loadProducts() {
  const { data } = await sb.from("products").select("id,name")
  data.forEach(p => productMap[p.id] = p.name)
}

async function loadTables() {
  const { data } = await sb.from("tables").select("id,table_no")
  data.forEach(t => tableMap[t.id] = t.table_no)
}

async function loadOrdersMap() {
  const { data } = await sb
    .from("orders")
    .select("id,table_id")
    .eq("status","open")

  orderTableMap = {}
  data.forEach(o => orderTableMap[o.id] = tableMap[o.table_id])
}

/* ===== load bills ===== */
async function loadBills() {
  billList.innerHTML = ""

  const { data } = await sb
    .from("order_items")
    .select("*")
    .eq("status","pending")
    .order("created_at",{ascending:true})

  const grouped = {}
  data.forEach(it => {
    if (!grouped[it.order_id]) grouped[it.order_id] = []
    grouped[it.order_id].push(it)
  })

  Object.entries(grouped).forEach(([orderId, items]) => {
    const card = document.createElement("div")
    card.className = "bg-slate-800 p-4 rounded-xl border border-slate-700"

    card.innerHTML = `
      <div class="flex justify-between items-center mb-2">
        <div class="font-bold text-lg">
          ğŸ½ï¸ à¹‚à¸•à¹Šà¸° ${orderTableMap[orderId] || "-"}
        </div>
        <button
          data-confirm-order="${orderId}"
          class="bg-green-600 px-3 py-1 rounded font-bold">
          âœ… à¸¢à¸·à¸™à¸¢à¸±à¸™à¸­à¸­à¸£à¹Œà¹€à¸”à¸­à¸£à¹Œ
        </button>
      </div>

      ${items.map(it => `
        <div class="flex justify-between items-center border-b py-1">
          <div>${productMap[it.product_id]} x ${it.qty}</div>
          <button
            data-cancel-item="${it.id}"
            class="bg-red-600 px-2 rounded text-white">
            âœ•
          </button>
        </div>
      `).join("")}
    `
    billList.appendChild(card)
  })
}

/* ===== actions ===== */
document.addEventListener("click", async e => {

  /* à¸¢à¸·à¸™à¸¢à¸±à¸™à¸­à¸­à¸£à¹Œà¹€à¸”à¸­à¸£à¹Œà¸—à¸±à¹‰à¸‡à¸šà¸´à¸¥ */
  const confirmOrderId = e.target.dataset.confirmOrder
  if (confirmOrderId) {
    const res = await Swal.fire({
      title: "à¸¢à¸·à¸™à¸¢à¸±à¸™à¸­à¸­à¸£à¹Œà¹€à¸”à¸­à¸£à¹Œà¸—à¸±à¹‰à¸‡à¸šà¸´à¸¥?",
      text: "à¸£à¸²à¸¢à¸à¸²à¸£à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸ˆà¸°à¸–à¸¹à¸à¸ªà¹ˆà¸‡à¹„à¸›à¸„à¸´à¸”à¹€à¸‡à¸´à¸™",
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "à¸¢à¸·à¸™à¸¢à¸±à¸™",
      cancelButtonText: "à¸¢à¸à¹€à¸¥à¸´à¸",
      confirmButtonColor: "#16a34a",
      cancelButtonColor: "#64748b"
    })
    if (!res.isConfirmed) return

    await sb.from("order_items")
      .update({ status: "done" })
      .eq("order_id", confirmOrderId)
      .eq("status", "pending")

    loadBills()
  }

  /* à¸¢à¸à¹€à¸¥à¸´à¸à¸£à¸²à¸¢à¸à¸²à¸£à¹€à¸”à¸µà¸¢à¸§ */
  const cancelItemId = e.target.dataset.cancelItem
  if (cancelItemId) {
    const res = await Swal.fire({
      title: "à¸¢à¸à¹€à¸¥à¸´à¸à¸£à¸²à¸¢à¸à¸²à¸£à¸™à¸µà¹‰?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "à¸¢à¸à¹€à¸¥à¸´à¸",
      cancelButtonText: "à¹„à¸¡à¹ˆ",
      confirmButtonColor: "#dc2626",
      cancelButtonColor: "#64748b"
    })
    if (!res.isConfirmed) return

    await sb.from("order_items")
      .update({ status: "cancelled" })
      .eq("id", cancelItemId)

    loadBills()
  }
})

/* ===== init ===== */
;(async()=>{
  await loadProducts()
  await loadTables()
  await loadOrdersMap()
  loadBills()
})()
</script>

</body>
</html>
