<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>üë®‚Äçüç≥ Kitchen</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link rel="icon" href="data:,">
</head>

<body class="bg-slate-900 text-white min-h-screen p-4">

<audio id="dingSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<div class="max-w-6xl mx-auto">
  <h1 class="text-2xl font-bold mb-4">üë®‚Äçüç≥ ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß</h1>
  <div id="orderList" class="space-y-4"></div>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co"
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

/* ================= STATE ================= */
const orderList = document.getElementById("orderList")
const ding = document.getElementById("dingSound")
let knownItemIds = new Set()

/* ================= LOAD ORDERS ================= */
async function loadOrders(playSound = false) {
  const { data, error } = await sb
    .from("order_items")
    .select(`
      id,
      qty,
      option_special,
      option_mix,
      status,
      product:products!order_items_product_id_fkey(name),
      mix:products!order_items_mix_sauce_id_fkey(name),
      orders(
        tables(table_no)
      )
    `)
    .eq("status", "pending")
    .order("created_at", { ascending: true })

  if (error) {
    console.error("loadOrders error", error)
    return
  }

  orderList.innerHTML = ""
  let hasNew = false

  data.forEach(item => {
    if (!knownItemIds.has(item.id)) {
      knownItemIds.add(item.id)
      hasNew = true
    }

    const mixText = item.option_mix && item.mix
      ? ` (‡∏ú‡∏™‡∏° ${item.mix.name})`
      : ""

    const card = document.createElement("div")
    card.className = "bg-slate-800 p-4 rounded-xl border border-slate-700"

    card.innerHTML = `
      <div class="flex justify-between items-center mb-2">
        <div class="font-bold text-lg">
          üçΩÔ∏è ‡πÇ‡∏ï‡πä‡∏∞ ${item.orders.tables.table_no}
        </div>
        <button class="doneBtn bg-green-600 px-4 py-1 rounded">
          ‚úÖ ‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
        </button>
      </div>

      <div class="text-xl font-bold">
        ${item.product.name}
        ${item.option_special ? "(‡∏û‡∏¥‡πÄ‡∏®‡∏©)" : ""}
        ${mixText}
      </div>

      <div class="text-sm text-gray-300 mt-1">
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <b>${item.qty}</b> ‡∏ó‡∏µ‡πà
      </div>
    `

    card.querySelector(".doneBtn").onclick = async () => {
      const confirm = await Swal.fire({
        title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß?",
        text: `${item.product.name} x ${item.qty}`,
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß",
        cancelButtonText: "‡∏¢‡∏±‡∏á"
      })

      if (!confirm.isConfirmed) return

      await sb
        .from("order_items")
        .update({ status: "done" })
        .eq("id", item.id)

      Swal.fire({
        toast: true,
        position: "top-end",
        icon: "success",
        title: "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡πâ‡∏ß",
        showConfirmButton: false,
        timer: 1200
      })

      loadOrders()
    }

    orderList.appendChild(card)
  })

  if (playSound && hasNew) {
    ding.currentTime = 0
    ding.play()
  }
}

/* ================= REALTIME ================= */
sb.channel("kitchen-realtime")
  .on(
    "postgres_changes",
    { event: "INSERT", schema: "public", table: "order_items" },
    payload => {
      if (payload.new.status === "pending") {
        loadOrders(true)
      }
    }
  )
  .on(
    "postgres_changes",
    { event: "UPDATE", schema: "public", table: "order_items" },
    () => loadOrders()
  )
  .subscribe()

/* ================= FALLBACK POLLING ================= */
setInterval(() => loadOrders(), 3000)

/* ================= INIT ================= */
loadOrders()
</script>

</body>
</html>
