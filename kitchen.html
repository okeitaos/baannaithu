<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>üë®‚Äçüç≥ Kitchen (By Bill)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link rel="icon" href="data:,">
</head>

<body class="bg-slate-900 text-white min-h-screen p-4">

<div class="max-w-7xl mx-auto">
  <h1 class="text-2xl font-bold mb-4">üë®‚Äçüç≥ ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå)</h1>
  <div id="billList" class="grid md:grid-cols-2 gap-4"></div>
</div>

<script>
/* ================= CONFIG ================= */
const sb = supabase.createClient(
  "https://nvsptbbvxjulrpdebrhn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
)

/* ================= STATE ================= */
const billList = document.getElementById("billList")
let productMap = {}
let tableMap = {}
let orderTableMap = {}

/* ================= MASTER ================= */
async function loadProducts() {
  const { data } = await sb.from("products").select("id,name")
  ;(data || []).forEach(p => productMap[p.id] = p.name)
}

async function loadTables() {
  const { data } = await sb.from("tables").select("id,table_no")
  ;(data || []).forEach(t => tableMap[t.id] = t.table_no)
}

async function loadOrdersMap() {
  const { data } = await sb
    .from("orders")
    .select("id,table_id")
    .eq("status", "open")

  orderTableMap = {}
  ;(data || []).forEach(o => {
    orderTableMap[o.id] = tableMap[o.table_id] || "-"
  })
}

/* ================= LOAD BILLS ================= */
async function loadBills() {
  billList.innerHTML = ""

  const { data, error } = await sb
    .from("order_items")
    .select("*")
    .eq("status", "pending")
    .order("created_at", { ascending: true })

  if (error) {
    console.error(error)
    return
  }

  const bills = {}
  ;(data || []).forEach(item => {
    if (!bills[item.order_id]) bills[item.order_id] = []
    bills[item.order_id].push(item)
  })

  for (const [orderId, items] of Object.entries(bills)) {
    const tableNo = orderTableMap[orderId] || "-"

    const card = document.createElement("div")
    card.className = "bg-slate-800 p-4 rounded-xl border border-slate-700"

    let itemsHTML = ""

    items.forEach(it => {
      const name = productMap[it.product_id] || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠"

      itemsHTML += `
        <div class="flex justify-between items-center border-b border-slate-700 py-1">
          <div class="flex-1">
            ${name}
            ${it.option_special ? "(‡∏û‡∏¥‡πÄ‡∏®‡∏©)" : ""}
          </div>

          <div class="flex items-center gap-2">
            <button class="dec bg-slate-600 px-2 rounded">‚àí</button>
            <span class="font-bold">${it.qty}</span>
            <button class="inc bg-slate-600 px-2 rounded">+</button>
            <button class="split bg-blue-600 px-2 rounded">‚áÑ</button>
            <button class="cancel text-white bg-red-600 px-2 rounded">‚úï</button>
          </div>
        </div>
      `
    })

    card.innerHTML = `
      <div class="flex justify-between mb-3">
        <div class="font-bold text-lg">üçΩÔ∏è ‡πÇ‡∏ï‡πä‡∏∞ ${tableNo}</div>
      </div>
      ${itemsHTML}
    `

    /* ===== bind actions ===== */
    const rows = card.querySelectorAll(".border-b")
    rows.forEach((row, index) => {
      const item = items[index]

      // ‡∏•‡∏î
      row.querySelector(".dec").onclick = () =>
        updateQty(item, item.qty - 1)

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°
      row.querySelector(".inc").onclick = () =>
        updateQty(item, item.qty + 1)

      // split
      row.querySelector(".split").onclick = () =>
        splitItem(item)

      // cancel
      row.querySelector(".cancel").onclick = () =>
        cancelItem(item)
    })

    billList.appendChild(card)
  }
}

/* ================= ACTIONS ================= */

// update qty
async function updateQty(item, newQty) {
  if (newQty <= 0) {
    await cancelItem(item)
    return
  }

  await sb
    .from("order_items")
    .update({ qty: newQty })
    .eq("id", item.id)

  loadBills()
}

// cancel item
async function cancelItem(item) {
  const confirm = await Swal.fire({
    title: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
    cancelButtonText: "‡πÑ‡∏°‡πà"
  })

  if (!confirm.isConfirmed) return

  await sb
    .from("order_items")
    .update({ status: "cancelled" })
    .eq("id", item.id)

  loadBills()
}

// split item
async function splitItem(item) {
  if (item.qty < 2) {
    Swal.fire("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏¢‡∏Å‡πÑ‡∏î‡πâ", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1", "info")
    return
  }

  // ‡∏•‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
  await sb
    .from("order_items")
    .update({ qty: item.qty - 1 })
    .eq("id", item.id)

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà qty = 1
  await sb
    .from("order_items")
    .insert({
      order_id: item.order_id,
      product_id: item.product_id,
      qty: 1,
      price: item.price,
      status: "pending",
      option_special: item.option_special,
      option_mix: item.option_mix,
      mix_sauce_id: item.mix_sauce_id
    })

  loadBills()
}

/* ================= INIT ================= */
;(async () => {
  await loadProducts()
  await loadTables()
  await loadOrdersMap()
  loadBills()
})()
</script>

</body>
</html>
