<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>üë®‚Äçüç≥ Kitchen</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link rel="icon" href="data:,">
</head>

<body class="bg-slate-900 text-white min-h-screen p-4">

<div class="max-w-7xl mx-auto">
  <h1 class="text-2xl font-bold mb-4">üë®‚Äçüç≥ ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ß</h1>
  <div id="billList" class="grid md:grid-cols-2 gap-4"></div>
</div>

<script>
const sb = supabase.createClient(
  "https://nvsptbbvxjulrpdebrhn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss"
)

const billList = document.getElementById("billList")
let productMap = {}
let tableMap = {}
let orderTableMap = {}

/* ===== master ===== */
async function loadProducts() {
  const { data } = await sb.from("products").select("id,name")
  data.forEach(p => productMap[p.id] = p.name)
}

async function loadTables() {
  const { data } = await sb.from("tables").select("id,table_no")
  data.forEach(t => tableMap[t.id] = t.table_no)
}

async function loadOrdersMap() {
  const { data } = await sb.from("orders").select("id,table_id").eq("status","open")
  orderTableMap = {}
  data.forEach(o => orderTableMap[o.id] = tableMap[o.table_id])
}

/* ===== load ===== */
async function loadBills() {
  billList.innerHTML = ""

  const { data } = await sb
    .from("order_items")
    .select("*")
    .eq("status","pending")
    .order("created_at",{ascending:true})

  const grouped = {}
  data.forEach(it => {
    if (!grouped[it.order_id]) grouped[it.order_id] = []
    grouped[it.order_id].push(it)
  })

  Object.entries(grouped).forEach(([orderId, items]) => {
    const card = document.createElement("div")
    card.className = "bg-slate-800 p-4 rounded-xl"

    card.innerHTML = `
      <div class="font-bold mb-2">üçΩÔ∏è ‡πÇ‡∏ï‡πä‡∏∞ ${orderTableMap[orderId] || "-"}</div>
      ${items.map(it => `
        <div class="flex justify-between items-center border-b py-1">
          <div>${productMap[it.product_id]}</div>
          <div class="flex gap-2">
            <button data-dec="${it.id}" class="bg-slate-600 px-2 rounded">‚àí</button>
            <span>${it.qty}</span>
            <button data-inc="${it.id}" class="bg-slate-600 px-2 rounded">+</button>
            <button data-cancel="${it.id}" class="bg-red-600 px-2 rounded">‚úï</button>
          </div>
        </div>
      `).join("")}
    `

    billList.appendChild(card)
  })
}

/* ===== actions ===== */
document.addEventListener("click", async e => {
  const dec = e.target.dataset.dec
  const inc = e.target.dataset.inc
  const cancel = e.target.dataset.cancel

  if (cancel) {
    const res = await Swal.fire({
      title: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
      cancelButtonText: "‡πÑ‡∏°‡πà"
    })
    if (!res.isConfirmed) return

    await sb.from("order_items")
      .update({ status:"cancelled" })
      .eq("id", cancel)

    loadBills()
  }

  if (dec || inc) {
    const id = dec || inc
    const { data:[item] } = await sb.from("order_items").select("*").eq("id",id)
    const newQty = dec ? item.qty - 1 : item.qty + 1

    if (newQty <= 0) {
      await sb.from("order_items").update({status:"cancelled"}).eq("id",id)
    } else {
      await sb.from("order_items").update({qty:newQty}).eq("id",id)
    }

    loadBills()
  }
})

/* ===== init ===== */
;(async()=>{
  await loadProducts()
  await loadTables()
  await loadOrdersMap()
  loadBills()
})()
</script>

</body>
</html>
