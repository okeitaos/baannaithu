<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üç≥ Kitchen Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-slate-900 text-white p-4">

<h1 class="text-2xl font-bold text-center mb-4">üç≥ ‡∏Ñ‡∏£‡∏±‡∏ß</h1>

<div id="orderList" class="space-y-4"></div>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= LOAD ORDERS ================= */
async function loadOrders(){
  const { data: orders, error } = await db
    .from('orders')
    .select(`
      id,
      status,
      created_at,
      tables ( name ),
      order_items (
        product_name,
        qty
      )
    `)
    .eq('status','open')
    .order('created_at',{ ascending:true });

  if(error){
    console.error(error);
    return;
  }

  orderList.innerHTML = '';

  if(!orders || !orders.length){
    orderList.innerHTML =
      `<div class="text-center text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>`;
    return;
  }

  orders.forEach(o=>{
    const card = document.createElement('div');
    card.className =
      'bg-slate-800 p-4 rounded-xl border border-slate-700';

    card.innerHTML = `
      <div class="flex justify-between mb-2">
        <div class="font-bold text-lg">
          ü™ë ‡πÇ‡∏ï‡πä‡∏∞ ${o.tables?.name || '-'}
        </div>
        <div class="text-sm text-slate-400">
          ${new Date(o.created_at)
            .toLocaleTimeString('th-TH',{ hour:'2-digit', minute:'2-digit' })}
        </div>
      </div>

      <div class="space-y-1 mb-3">
        ${
          o.order_items && o.order_items.length
          ? o.order_items.map(i=>`
              <div class="flex justify-between text-sm">
                <span>${i.product_name}</span>
                <span>x${i.qty}</span>
              </div>
            `).join('')
          : `<div class="text-slate-400 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</div>`
        }
      </div>

      <button
        onclick="markDone('${o.id}')"
        class="w-full bg-emerald-600 py-2 rounded font-bold">
        ‚úÖ ‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
      </button>
    `;

    orderList.appendChild(card);
  });
}

/* ================= MARK DONE ================= */
async function markDone(orderId){
  const r = await Swal.fire({
    title:'‡∏ó‡∏≥‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß?',
    icon:'question',
    showCancelButton:true,
    confirmButtonText:'‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß',
    cancelButtonText:'‡∏¢‡∏±‡∏á'
  });

  if(!r.isConfirmed) return;

  await db
    .from('orders')
    .update({ status:'done' })
    .eq('id',orderId);

  loadOrders();
}

/* ================= REALTIME ================= */
const channel = db.channel('kitchen-realtime')

  // ‡∏ü‡∏±‡∏á orders
  .on(
    'postgres_changes',
    { event:'*', schema:'public', table:'orders' },
    () => loadOrders()
  )

  // ‡∏ü‡∏±‡∏á order_items (‡∏ï‡∏±‡∏ß‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å)
  .on(
    'postgres_changes',
    { event:'*', schema:'public', table:'order_items' },
    () => loadOrders()
  )

  .subscribe();

/* ================= START ================= */
loadOrders();
</script>

</body>
</html>
