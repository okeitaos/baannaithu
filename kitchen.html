<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>üç≥ ‡∏Ñ‡∏£‡∏±‡∏ß</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-slate-900 text-white p-4">

<h1 class="text-2xl font-bold text-center mb-4">üç≥ ‡∏Ñ‡∏£‡∏±‡∏ß</h1>

<div id="orderList" class="space-y-4"></div>

<script>
const SUPABASE_URL = "https://nvsptbbvxjulrpdebrhn.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52c3B0YmJ2eGp1bHJwZGVicmhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTc1NTAsImV4cCI6MjA4MzE5MzU1MH0.sQ8XqdAKCsaxWupP3QZjFOraEHyW8agSo3c3BR3I8ss";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= LOAD ================= */
async function loadOrders(){
  const { data } = await db
    .from('orders')
    .select(`
      id,
      created_at,
      tables(name),
      order_items(product_name,qty)
    `)
    .eq('status','open')
    .order('created_at',{ascending:true});

  orderList.innerHTML='';

  if(!data || !data.length){
    orderList.innerHTML = `<div class="text-center text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>`;
    return;
  }

  data.forEach(o=>{
    orderList.innerHTML+=`
      <div class="bg-slate-800 p-4 rounded">
        <div class="flex justify-between mb-2">
          <b>‡πÇ‡∏ï‡πä‡∏∞ ${o.tables?.name}</b>
          <span>${new Date(o.created_at).toLocaleTimeString('th-TH')}</span>
        </div>
        ${o.order_items.map(i=>`
          <div class="flex justify-between text-sm">
            <span>${i.product_name}</span>
            <span>x${i.qty}</span>
          </div>
        `).join('')}
      </div>
    `;
  });
}

/* ================= REALTIME ================= */
db.channel('kitchen-live')
  .on('broadcast',{event:'new_order'},()=>loadOrders())
  .on('postgres_changes',
    { event:'*', schema:'public', table:'orders' },
    ()=>loadOrders()
  )
  .subscribe();

/* ================= START ================= */
loadOrders();
</script>

</body>
</html>
